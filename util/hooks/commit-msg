#!/bin/bash
#
# Git commit-msg hook for lokt
#
# Checks:
# 1. Conventional commit format (type(scope): description)
# 2. No LLM advertising (Co-Authored-By, AI branding)
#

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Get first line (subject)
SUBJECT=$(echo "$COMMIT_MSG" | head -n1)

# Skip merge commits
if echo "$SUBJECT" | grep -qE "^Merge "; then
    exit 0
fi

# =============================================================================
# 1. Conventional Commit Format
# =============================================================================

# Valid types
TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Pattern: type(scope): description  OR  type: description
CONVENTIONAL_PATTERN="^($TYPES)(\([a-z0-9_-]+\))?: .+"

if ! echo "$SUBJECT" | grep -qE "$CONVENTIONAL_PATTERN"; then
    echo "ERROR: Commit message does not follow Conventional Commits format"
    echo ""
    echo "Expected: <type>(<scope>): <description>"
    echo ""
    echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    echo "Scope: optional, lowercase (cli, lock, guard, stale, audit, root)"
    echo ""
    echo "Examples:"
    echo "  feat(cli): add --break-stale flag to unlock"
    echo "  fix(lock): handle race condition in acquire"
    echo "  docs: update CLAUDE.md with workflow"
    echo ""
    echo "Your subject: $SUBJECT"
    exit 1
fi

# Check subject length (soft warning at 50, hard limit at 72)
SUBJECT_LEN=${#SUBJECT}
if [[ $SUBJECT_LEN -gt 72 ]]; then
    echo "ERROR: Subject line too long ($SUBJECT_LEN chars, max 72)"
    echo ""
    echo "Your subject: $SUBJECT"
    exit 1
fi

if [[ $SUBJECT_LEN -gt 50 ]]; then
    echo "WARNING: Subject line is $SUBJECT_LEN chars (prefer <= 50)"
fi

# =============================================================================
# 2. Block LLM Advertising
# =============================================================================

BLOCKED_PATTERNS=(
    "Co-Authored-By:"
    "Co-authored-by:"
    "Coauthored-by:"
    "noreply@anthropic.com"
    "noreply@openai.com"
    "bot@"
)

BLOCKED_PHRASES=(
    "Generated with Claude"
    "Generated by Claude"
    "Created with Claude"
    "Written by Claude"
    "Claude Code"
    "Generated with ChatGPT"
    "Generated by ChatGPT"
    "Generated with GPT"
    "Generated by GPT"
    "Generated with Copilot"
    "GitHub Copilot"
    "Generated with Gemini"
    "Generated by Gemini"
    "AI-assisted"
    "AI assisted"
)

for pattern in "${BLOCKED_PATTERNS[@]}"; do
    if echo "$COMMIT_MSG" | grep -qi "$pattern"; then
        echo "ERROR: Commit message contains blocked pattern: '$pattern'"
        echo ""
        echo "LLM advertising and Co-Authored-By lines are not allowed."
        exit 1
    fi
done

for phrase in "${BLOCKED_PHRASES[@]}"; do
    if echo "$COMMIT_MSG" | grep -qiF "$phrase"; then
        echo "ERROR: Commit message contains blocked phrase: '$phrase'"
        echo ""
        echo "LLM advertising is not allowed in commit messages."
        exit 1
    fi
done

exit 0
