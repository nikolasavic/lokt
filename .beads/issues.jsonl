{"id":"lokt-b0a","title":"L-130 ttl-stale-handling","description":"## Summary\nImplement safe handling of stale/expired locks through TTL enforcement and PID liveness detection.\n\n## Acceptance Criteria\n- [ ] `unlock --break-stale` removes expired locks\n- [ ] `unlock --break-stale` refuses to break non-expired locks (exit code 1)\n- [ ] `unlock --break-stale` removes locks where PID is dead (same host only)\n- [ ] `status` shows PID liveness (alive/dead/unknown) on same host\n- [ ] `status --prune-expired` removes expired locks and reports them\n- [ ] `--ttl 0` or negative durations produce clear error\n- [ ] All new functionality has unit tests\n\n## Plan\n\n### Strategy\nBuild on existing TTL infrastructure (`Lock.IsExpired()`, `--ttl` flags) by adding:\n1. PID liveness detection in a new `internal/stale` package\n2. `--break-stale` option to Release()\n3. Status enhancement for liveness display\n4. Duration validation in command parsing\n\n### Patterns\n- Mirror: `internal/lock/release.go` for ownership check pattern\n- Mirror: `cmd/lokt/main.go:117` for flag handling pattern\n\n### Key Decisions\n- PID check only on same host (cross-host = unknown)\n- EPERM from kill(0) means process is alive (can't signal, but exists)\n- Windows: skip PID check, rely on TTL only\n\n## Edge Cases\n- Cross-host locks: Cannot verify PID - treat as unknown\n- PID reuse: Rare but TTL provides backup protection\n- Race conditions: Lock disappears between read/remove - handle gracefully\n- Permission errors: Cannot signal PID - treat as alive (safe default)\n\n## Constraints\n- No external dependencies for PID liveness\n- Must work on macOS and Linux\n- Windows fallback behavior\n- Backward compatible with existing lock files","notes":"source: _notes/story-drafts/l-130-ttl-stale-handling.md\nverify-level: agent\nverify-envs: local","status":"open","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:21:45.300561-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:21:45.300561-05:00","labels":["L-130","story"]}
{"id":"lokt-b0a.1","title":"L-130 internal: add stale detection package","description":"## What\nCreate `internal/stale` package with PID liveness detection.\n\n## Why\nCentralizes stale lock detection logic for use by both unlock and status commands.\n\n## Pattern\nMirror: `internal/identity/identity.go` for simple utility package pattern.\n\n## Implementation\n1. Create `internal/stale/stale.go`\n2. Add `IsProcessAlive(pid int) bool` - uses `syscall.Kill(pid, 0)`\n3. Add `IsStale(lock *lockfile.Lock) (stale bool, reason string)` - checks TTL expiry OR dead PID (same host)\n4. Add build tags for Unix vs Windows\n\n## Acceptance\n- [ ] `IsProcessAlive()` returns true for current PID\n- [ ] `IsProcessAlive()` returns false for non-existent PID\n- [ ] `IsStale()` returns true for expired TTL\n- [ ] `IsStale()` returns true for dead PID on same host\n- [ ] `IsStale()` returns false for different host (cannot verify)\n- [ ] Has unit tests","notes":"env: local\nverify: agent\nmaps-to-ac: R2 PID liveness check","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:19.932847-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:25:54.412672-05:00","closed_at":"2026-01-27T08:25:54.412672-05:00","close_reason":"## Evidence\n- Created internal/stale package with PID liveness detection\n- IsProcessAlive() uses syscall.Kill(pid, 0) on Unix\n- Windows fallback returns true (conservative)\n- Check() returns stale for expired TTL or dead PID (same host)\n- All 7 unit tests pass","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.1","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:19.935997-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.2","title":"L-130 lock: add break-stale to Release","description":"## What\nAdd `BreakStale` option to `lock.Release()` that removes expired/stale locks only.\n\n## Why\nProvides a safe middle ground between `--force` (break-glass) and normal unlock (owner-only).\n\n## Pattern\nMirror: `internal/lock/release.go:36` - extend `ReleaseOptions` struct.\n\n## Implementation\n1. Add `BreakStale bool` to `ReleaseOptions`\n2. In `Release()`, if BreakStale:\n   - Check `stale.IsStale(existing)`\n   - If stale, remove lock (skip ownership check)\n   - If not stale, return new `ErrNotStale` error\n3. Add `ErrNotStale` error type with details\n\n## Acceptance\n- [ ] `Release(opts{BreakStale: true})` removes expired locks\n- [ ] `Release(opts{BreakStale: true})` removes dead-PID locks (same host)\n- [ ] `Release(opts{BreakStale: true})` returns `ErrNotStale` for non-stale locks\n- [ ] Existing `Force` behavior unchanged\n- [ ] Has unit tests","notes":"env: local\nverify: agent\nmaps-to-ac: R1 break-stale flag","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:23.694258-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:27:20.617404-05:00","closed_at":"2026-01-27T08:27:20.617404-05:00","close_reason":"## Evidence\n- Added BreakStale option to ReleaseOptions\n- Added ErrNotStale error and NotStaleError type\n- Release() checks stale.Check() when BreakStale is true\n- Returns NotStaleError if lock is not stale\n- All 8 release tests pass including 4 new break-stale tests","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.2","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:23.696431-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-b0a.2","depends_on_id":"lokt-b0a.1","type":"blocks","created_at":"2026-01-27T08:22:43.286003-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.3","title":"L-130 cli: add --break-stale to unlock command","description":"## What\nAdd `--break-stale` flag to `lokt unlock` CLI command.\n\n## Why\nExposes the safe stale-lock removal to users.\n\n## Pattern\nMirror: `cmd/lokt/main.go:119` - existing `--force` flag pattern.\n\n## Implementation\n1. Add `breakStale` flag to `cmdUnlock()`\n2. Pass to `lock.Release()` as `BreakStale` option\n3. Handle `ErrNotStale` with appropriate exit code and message\n4. Update usage text\n\n## Acceptance\n- [ ] `lokt unlock --break-stale \u003cname\u003e` removes expired locks\n- [ ] `lokt unlock --break-stale \u003cname\u003e` returns exit 1 for non-stale locks\n- [ ] Error message explains why lock is not stale\n- [ ] Usage text updated","notes":"env: local\nverify: agent\nmaps-to-ac: R1 break-stale flag","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:26.823089-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:29:11.041207-05:00","closed_at":"2026-01-27T08:29:11.041207-05:00","close_reason":"## Evidence\n- Added --break-stale flag to cmdUnlock()\n- Passes BreakStale option to lock.Release()\n- Handles NotStaleError with clear error message\n- Updated usage text with flag descriptions\n- Build and all tests pass","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.3","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:26.825407-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-b0a.3","depends_on_id":"lokt-b0a.2","type":"blocks","created_at":"2026-01-27T08:22:46.007736-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.4","title":"L-130 cli: enhance status with liveness display","description":"## What\nShow PID liveness status in `lokt status` output.\n\n## Why\nHelps users identify stale locks before deciding to break them.\n\n## Pattern\nMirror: `cmd/lokt/main.go:296` - existing `showLock()` function.\n\n## Implementation\n1. In `showLock()` and `showLockBrief()`, check PID liveness\n2. Display status: `alive`, `dead`, or `unknown` (cross-host)\n3. Format: `pid: 1234 (alive)` or `pid: 1234 (dead)`\n4. In brief format: add indicator like `[DEAD]`\n\n## Acceptance\n- [ ] `lokt status \u003cname\u003e` shows PID liveness status\n- [ ] `lokt status` (list) shows liveness indicator\n- [ ] Cross-host locks show `unknown`\n- [ ] JSON output includes liveness field","notes":"env: local\nverify: agent\nmaps-to-ac: R2 PID liveness check","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:29.559726-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:36:41.929526-05:00","closed_at":"2026-01-27T08:36:41.929526-05:00","close_reason":"## Evidence\n- Added pidLiveness() helper using stale.IsProcessAlive()\n- showLock() displays: pid: 1234 (alive|dead|unknown)\n- showLockBrief() adds [DEAD] marker for dead PIDs\n- Cross-host locks show 'unknown' (cannot verify)\n- All tests pass","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.4","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:29.561581-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-b0a.4","depends_on_id":"lokt-b0a.1","type":"blocks","created_at":"2026-01-27T08:22:49.008389-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.5","title":"L-130 cli: add --prune-expired to status","description":"## What\nAdd `--prune-expired` flag to `lokt status` that removes expired locks.\n\n## Why\nProvides convenient cleanup of expired locks during status check.\n\n## Pattern\nMirror: `cmd/lokt/main.go:153` - existing `cmdStatus()` function.\n\n## Implementation\n1. Add `pruneExpired` flag to `cmdStatus()`\n2. When listing locks, check expiry\n3. If expired and prune enabled, remove lock\n4. Report pruned locks in output\n\n## Acceptance\n- [ ] `lokt status --prune-expired` removes expired locks\n- [ ] Output shows which locks were pruned\n- [ ] Non-expired locks are not affected\n- [ ] Works with specific lock name: `lokt status --prune-expired \u003cname\u003e`","notes":"env: local\nverify: agent\nmaps-to-ac: R3 auto-prune expired","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:32.40278-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:00:17.473691-05:00","closed_at":"2026-01-27T09:00:17.473691-05:00","close_reason":"## Evidence\n- Added --prune-expired flag to cmdStatus()\n- When listing, expired locks are removed and reported\n- When viewing specific lock with prune, removes if expired\n- Output shows 'pruned: {name} (expired)' and summary count\n- All tests pass\n- CLI tested manually with expired locks","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.5","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:32.40532-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.6","title":"L-130 cli: validate TTL duration","description":"## What\nValidate that TTL durations are positive values.\n\n## Why\nPrevents confusing behavior from zero or negative TTL.\n\n## Pattern\nMirror: `cmd/lokt/main.go:87` - existing TTL flag parsing.\n\n## Implementation\n1. After parsing `--ttl` flag, validate \u003e 0\n2. If zero or negative, print error and return ExitUsage\n3. Apply to both `lock` and `guard` commands\n\n## Acceptance\n- [ ] `lokt lock --ttl 0 foo` produces error\n- [ ] `lokt lock --ttl -5m foo` produces error\n- [ ] Error message is clear about valid values\n- [ ] `lokt guard --ttl 0 foo -- cmd` same behavior","notes":"env: local\nverify: agent\nmaps-to-ac: R4 duration validation","status":"in_progress","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:35.267113-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:00:43.112909-05:00","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.6","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:35.268922-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-y24","title":"L-130 verify:local","description":"Verification for L-130 TTL \u0026 Stale Lock Handling\n\nLinked story: lokt-b0a\n\n## Scope\n- Agent-verifiable: Unit tests, CLI tests\n\n## Environments\nlocal","notes":"linked-story: lokt-b0a\nverify-level: agent","status":"open","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:57.436712-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:22:57.436712-05:00","labels":["L-130","verification"]}
{"id":"lokt-y24.1","title":"L-130 verify:local unit tests pass","description":"## Check\nAll unit tests pass including new stale detection tests.\n\n## Command\n```bash\ngo test ./...\n```\n\n## Expected\nAll tests pass, including:\n- internal/stale tests\n- internal/lock/release_test.go with break-stale cases","notes":"env: local\nverify: agent\nmaps-to-ac: all","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:23:11.511272-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:23:11.511272-05:00","labels":["L-130","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-y24.1","depends_on_id":"lokt-y24","type":"parent-child","created_at":"2026-01-27T08:23:11.513044-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-y24.2","title":"L-130 verify:local --break-stale works","description":"## Check\n`unlock --break-stale` correctly removes expired locks and rejects non-stale locks.\n\n## Steps\n```bash\n# Create expired lock\nlokt lock --ttl 1s test-stale\nsleep 2\n\n# Should succeed (lock is expired)\nlokt unlock --break-stale test-stale\necho \"Exit code: $?\"\n\n# Create non-expired lock\nlokt lock --ttl 5m test-active\n\n# Should fail (lock not stale)\nlokt unlock --break-stale test-active\necho \"Exit code: $?\"\n\n# Cleanup\nlokt unlock --force test-active\n```\n\n## Expected\n- First unlock succeeds (exit 0)\n- Second unlock fails with \"not stale\" message (exit 1)","notes":"env: local\nverify: agent\nmaps-to-ac: R1","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:23:14.326902-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:23:14.326902-05:00","labels":["L-130","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-y24.2","depends_on_id":"lokt-y24","type":"parent-child","created_at":"2026-01-27T08:23:14.329341-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-y24.3","title":"L-130 verify:local status shows liveness","description":"## Check\n`lokt status` displays PID liveness information.\n\n## Steps\n```bash\n# Create a lock\nlokt lock test-liveness\n\n# Check status shows alive (our PID)\nlokt status test-liveness\n\n# Cleanup\nlokt unlock test-liveness\n```\n\n## Expected\n- Status output includes `pid: \u003cnumber\u003e (alive)` or similar\n- Brief listing shows liveness indicator","notes":"env: local\nverify: agent\nmaps-to-ac: R2","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:23:16.807211-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:23:16.807211-05:00","labels":["L-130","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-y24.3","depends_on_id":"lokt-y24","type":"parent-child","created_at":"2026-01-27T08:23:16.808984-05:00","created_by":"Nikola Savic"}]}
