{"id":"lokt-0il","title":"L-103 lock: integrate validation in Acquire/Release","description":"## What\nCall ValidateName early in lock.Acquire() and lock.Release() functions.\n\n## Pattern\nMirror error handling pattern from existing code (return wrapped errors).\n\n## Acceptance\n- [ ] Acquire returns error for invalid name before any file ops\n- [ ] Release returns error for invalid name before any file ops\n- [ ] CLI shows clear error message to user","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T10:08:22.319806-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T10:12:18.310389-05:00","closed_at":"2026-01-27T10:12:18.310389-05:00","close_reason":"Validation integrated in Acquire/Release, CLI shows clear errors","dependencies":[{"issue_id":"lokt-0il","depends_on_id":"lokt-1um","type":"blocks","created_at":"2026-01-27T10:09:13.008349-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-1um","title":"L-103 lockfile: add ValidateName function","description":"## What\nAdd ValidateName(name string) error function to internal/lockfile package.\n\n## Pattern\n- Regex: `^[A-Za-z0-9._-]+$`\n- Check for `..` substring\n- Check for leading `/`\n- Check for empty string\n\n## Acceptance\n- [ ] Function returns nil for valid names\n- [ ] Function returns descriptive error for invalid names\n- [ ] Unit tests cover all edge cases","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T10:08:13.247571-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T10:11:02.363062-05:00","closed_at":"2026-01-27T10:11:02.363062-05:00","close_reason":"ValidateName function added with comprehensive tests (22 test cases)"}
{"id":"lokt-26j","title":"L-200 verify:sandbox","description":"Verification for L-200 heartbeat-lease-renewal\n\nLinked story: lokt-dxz\n\n## Scope\n- Agent-verifiable: Lock renewal via CLI tests, audit log inspection\n- Human-verifiable: None (all acceptance criteria are testable via CLI)\n\n## Environments\nsandbox (local testing)","notes":"linked-story: lokt-dxz\nverify-level: required","status":"closed","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:00:41.912621-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T15:53:04.270517-05:00","closed_at":"2026-01-28T15:53:04.270517-05:00","close_reason":"All 4 sandbox verification tasks passed: heartbeat renewal, no-TTL no-heartbeat, audit renew events, stolen lock warning."}
{"id":"lokt-31a","title":"L-140 verify:sandbox","description":"Verification for L-140 lock --wait flag\n\nLinked story: lokt-eie\n\n## Scope\n- Agent-verifiable: CLI behavior, exit codes, signal handling\n- All verification can be done locally (sandbox)","notes":"linked-story: lokt-eie\nverify-level: optional","status":"closed","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T14:00:35.367153-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T14:08:49.623305-05:00","closed_at":"2026-01-27T14:08:49.623305-05:00","close_reason":"All verification tasks completed."}
{"id":"lokt-31a.1","title":"L-140 verify:sandbox wait acquires after release","description":"## Check\nVerify `lokt lock --wait` acquires lock after holder releases it.\n\n## Command\n```bash\n# Terminal 1: Hold lock\nlokt lock test-wait\n\n# Terminal 2: Start wait (in background)\nlokt lock --wait test-wait \u0026\nWAIT_PID=$!\n\n# Terminal 1: Release after 1s\nsleep 1 \u0026\u0026 lokt unlock test-wait\n\n# Check wait process succeeded\nwait $WAIT_PID\necho \"Exit code: $?\"\n```\n\n## Expected\n- Wait command blocks until lock released\n- Exit code 0 after acquiring","notes":"env: sandbox\nverify: agent\nmaps-to-ac: basic-wait","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T14:00:44.613232-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T14:08:35.33971-05:00","closed_at":"2026-01-27T14:08:35.33971-05:00","close_reason":"Verified: wait acquires after lock release (exit code 0). Also verified stale lock auto-break works correctly.","dependencies":[{"issue_id":"lokt-31a.1","depends_on_id":"lokt-31a","type":"parent-child","created_at":"2026-01-27T14:00:44.616054-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-31a.2","title":"L-140 verify:sandbox signal cancels wait","description":"## Check\nVerify SIGINT cancels waiting cleanly.\n\n## Command\n```bash\n# Hold lock indefinitely\nlokt lock --ttl 1h signal-test\n\n# Start wait in background\nlokt lock --wait signal-test \u0026\nWAIT_PID=$!\nsleep 0.5\n\n# Send SIGINT\nkill -INT $WAIT_PID\nwait $WAIT_PID\necho \"Exit code: $?\"\n\n# Cleanup\nlokt unlock --force signal-test\n```\n\n## Expected\n- Wait command exits on SIGINT\n- Exit code is non-zero (1 or 130)","notes":"env: sandbox\nverify: agent\nmaps-to-ac: signal-handling","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T14:00:52.827199-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T14:08:42.1423-05:00","closed_at":"2026-01-27T14:08:42.1423-05:00","close_reason":"Verified: SIGINT cancels wait with exit code 124 (timeout/interrupt). Tested with non-stale remote lock.","dependencies":[{"issue_id":"lokt-31a.2","depends_on_id":"lokt-31a","type":"parent-child","created_at":"2026-01-27T14:00:52.829363-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-36j","title":"Add renewal-under-contention test","description":"Test that heartbeat renewal prevents stale-break while the lock holder is active. Scenario: start a guard with a short TTL (e.g., 2s), have a background goroutine attempt to acquire with --break-stale while the heartbeat is running, verify the lock is never broken while renewal is active. This is the 'renewal race' test — the gap most likely to hide a real bug where a contender breaks a lock that is being actively renewed. Ref: external technical review — test plan item 3.","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:01:22.58134-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:01:22.58134-05:00","labels":["test"]}
{"id":"lokt-396","title":"Structured JSON output on lock acquire failure","description":"When lokt lock fails with exit 2 (held by another owner), output JSON describing the holder via --json flag. Example: {\"status\":\"blocked\",\"name\":\"zone-api\",\"held_by\":\"session:abc123\",\"age_sec\":340,\"expires_in_sec\":3260}. Eliminates the need for a separate lokt status call after a failed acquire.","status":"open","priority":2,"issue_type":"feature","owner":"nikolasavic@gmail.com","created_at":"2026-01-30T19:19:10.06247-05:00","created_by":"Nikola Savic","updated_at":"2026-01-30T19:19:10.06247-05:00"}
{"id":"lokt-3jq","title":"Fsync parent directory on lock create/delete","description":"After creating or deleting a lock file, fsync the parent directory to ensure the directory entry is durably persisted. Without this, a power loss or hard reset could leave ghost locks (file synced but dir entry lost) or phantom deletions (file removed but dir entry cached). Implementation: after os.OpenFile with O_EXCL and after os.Remove, open the parent directory and call dir.Sync(). Apply to acquire, release, freeze, and unfreeze paths. Ref: external technical review — filesystem durability hardening.","status":"closed","priority":1,"issue_type":"bug","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:00:55.652589-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:07:52.260016-05:00","closed_at":"2026-01-28T22:07:52.260016-05:00","close_reason":"Added lockfile.SyncDir() helper and applied it to all 17 lock/freeze create and delete sites"}
{"id":"lokt-3x8","title":"Fix status \u003cname\u003e --json outputting human-readable text","description":"lokt status zone-api --json outputs human-readable text instead of JSON. Named queries should respect --json flag same as the all-locks query does.","status":"closed","priority":1,"issue_type":"bug","owner":"nikolasavic@gmail.com","created_at":"2026-01-30T19:18:52.741303-05:00","created_by":"Nikola Savic","updated_at":"2026-01-30T19:26:12.000954-05:00","closed_at":"2026-01-30T19:26:12.000954-05:00","close_reason":"Fixed: Go's flag.Parse stops at first non-flag arg, so 'lokt status zone-api --json' left --json unparsed. Added arg reordering in cmdStatus to move flags before positional args. Verified both orderings output JSON. Commit: 725e1f9"}
{"id":"lokt-4u3","title":"L-141 timeout","description":"## Summary\nAdd `--timeout` duration flag to `lokt lock` command. When used with `--wait`, aborts after timeout with exit code 2 (ExitLockHeld).\n\n## Acceptance Criteria\n- [ ] **Timeout flag**: `lokt lock --wait --timeout 5s foo` waits up to 5 seconds\n- [ ] **Exit code on timeout**: When timeout expires, exit code is 2 (ExitLockHeld)\n- [ ] **Holder info on timeout**: Print who holds the lock when timing out\n- [ ] **Success before timeout**: If lock acquired before timeout, exit code is 0\n- [ ] **Usage validation**: `--timeout` without `--wait` prints usage error\n\n## Plan\n\n### Strategy\nUse `context.WithTimeout` wrapping the signal context. Existing `AcquireWithWait` already handles context cancellation - just need to detect timeout vs signal.\n\n### Patterns\n- Mirror: existing `--wait` implementation in cmdLock\n- Reuse: context.DeadlineExceeded detection for timeout\n\n### Key Decisions\n- Exit code 2 on timeout (same as immediate deny) for script compatibility\n- Require `--wait` with `--timeout` (explicit is better than implicit)\n\n## Constraints\n- No changes to internal/lock package needed\n- Preserve all L-140 behavior","notes":"source: _notes/story-drafts/l-141-timeout.md\nverify-level: optional","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T14:55:44.970398-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T15:12:32.394376-05:00","closed_at":"2026-01-27T15:12:32.394376-05:00","close_reason":"L-141 complete: Added --timeout flag for bounded wait times."}
{"id":"lokt-4u3.1","title":"L-141 cli: add --timeout flag","description":"## What\nAdd `--timeout` duration flag to `cmdLock` function that limits wait time.\n\n## Why\nUsers need bounded wait times for CI pipelines and scripts.\n\n## Implementation\n```go\ntimeout := fs.Duration(\"timeout\", 0, \"Maximum time to wait (requires --wait)\")\n\n// Validate: --timeout requires --wait\nif *timeout \u003e 0 \u0026\u0026 !*wait {\n    fmt.Fprintln(os.Stderr, \"error: --timeout requires --wait\")\n    return ExitUsage\n}\n\nif *wait {\n    ctx, cancel := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM)\n    defer cancel()\n    \n    if *timeout \u003e 0 {\n        ctx, cancel = context.WithTimeout(ctx, *timeout)\n        defer cancel()\n    }\n    \n    err = lock.AcquireWithWait(ctx, rootDir, name, opts)\n    if err != nil {\n        if errors.Is(err, context.DeadlineExceeded) {\n            // Timeout - get current holder for error message\n            // Print holder info and return ExitLockHeld\n        }\n        // ... rest of error handling\n    }\n}\n```\n\n## Acceptance\n- [ ] `--timeout` flag added\n- [ ] Timeout without --wait returns usage error\n- [ ] Exit code 2 on timeout\n- [ ] Holder info printed on timeout\n- [ ] Document in usage()","notes":"env: local\nverify: agent","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T14:56:04.384028-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T15:12:23.00786-05:00","closed_at":"2026-01-27T15:12:23.00786-05:00","close_reason":"Added --timeout flag. Exit code 2 on timeout with holder info. Commit: 09066ad","dependencies":[{"issue_id":"lokt-4u3.1","depends_on_id":"lokt-4u3","type":"parent-child","created_at":"2026-01-27T14:56:04.393756-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-64m","title":"L-203 verify:sandbox","description":"Verification for L-203 corrupted lock file handling.\n\nLinked story: lokt-afw\n\n## Scope\nAll checks are agent-verifiable via unit tests and CLI invocation.\n\n## Environments\n- sandbox (local dev)","status":"closed","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:40.889839-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:22:11.568385-05:00","closed_at":"2026-01-28T16:22:11.568385-05:00","close_reason":"Closed","labels":["L-203","verification"]}
{"id":"lokt-64m.1","title":"L-203 verify:sandbox acquire auto-prunes corrupted lock","description":"## Check\nAcquire succeeds when existing lock file contains corrupted JSON.\n\n## Command\n```bash\ngo test -run TestAcquire.*Corrupt -v ./internal/lock/\n```\n\n## Expected\n- Test passes: corrupted file removed, lock acquired\n- Audit event emitted with event=corrupted-break","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:53.170182-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:22:11.440821-05:00","closed_at":"2026-01-28T16:22:11.440821-05:00","close_reason":"Closed","labels":["L-203","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-64m.1","depends_on_id":"lokt-64m","type":"parent-child","created_at":"2026-01-28T16:11:53.178889-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-64m.2","title":"L-203 verify:sandbox release --break-stale removes corrupted lock","description":"## Check\nRelease with --break-stale removes corrupted lock files.\n\n## Command\n```bash\ngo test -run TestRelease.*Corrupt.*BreakStale -v ./internal/lock/\n```\n\n## Expected\n- Test passes: corrupted file removed without error","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:53.334731-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:22:11.472853-05:00","closed_at":"2026-01-28T16:22:11.472853-05:00","close_reason":"Closed","labels":["L-203","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-64m.2","depends_on_id":"lokt-64m","type":"parent-child","created_at":"2026-01-28T16:11:53.341591-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-64m.3","title":"L-203 verify:sandbox ErrCorrupted distinguishes parse errors","description":"## Check\nlockfile.Read() returns ErrCorrupted for malformed JSON but not for missing files or permission errors.\n\n## Command\n```bash\ngo test -run TestRead.*Corrupt -v ./internal/lockfile/\n```\n\n## Expected\n- errors.Is(err, ErrCorrupted) == true for bad JSON\n- errors.Is(err, ErrCorrupted) == false for os.ErrNotExist","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:53.49982-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:22:11.508314-05:00","closed_at":"2026-01-28T16:22:11.508314-05:00","close_reason":"Closed","labels":["L-203","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-64m.3","depends_on_id":"lokt-64m","type":"parent-child","created_at":"2026-01-28T16:11:53.508437-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-64m.4","title":"L-203 verify:sandbox all tests and lint pass","description":"## Check\nFull test suite and linter pass with L-203 changes.\n\n## Command\n```bash\ngo test ./... \u0026\u0026 golangci-lint run\n```\n\n## Expected\n- All tests pass\n- No lint errors","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:53.685283-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:22:11.539278-05:00","closed_at":"2026-01-28T16:22:11.539278-05:00","close_reason":"Closed","labels":["L-203","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-64m.4","depends_on_id":"lokt-64m","type":"parent-child","created_at":"2026-01-28T16:11:53.691293-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-65w","title":"DEMO verify:local","description":"Verification for DEMO Terminal Mosaic demo command.\n\nLinked story: lokt-7op\n\n## Scope\n- Agent-verifiable: build, run, verifier pass, determinism check, nolock failure detection\n- Human-verifiable: visual correctness, keyboard shortcuts, freeze animation\n\n## Environments\nlocal","notes":"linked-story: lokt-7op\nverify-level: agent+human\nverify-envs: local","status":"closed","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:56:43.539342-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T20:23:59.742971-05:00","closed_at":"2026-01-29T20:23:59.742971-05:00","close_reason":"Mosaic demo cancelled — approach won't work. Archived in lokt beads."}
{"id":"lokt-65w.1","title":"DEMO verify:local build and unit tests pass","description":"## Check\nBuild succeeds and all tests pass including new demo package tests.\n\n## Command\n```bash\n./scripts/build.sh \u0026\u0026 go test ./... \u0026\u0026 golangci-lint run\n```\n\n## Expected\n- Build succeeds with no errors\n- All tests pass (including demo package tests)\n- No lint violations","notes":"env: local\nverify: agent\nmaps-to-ac: build, tests","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:57:04.393845-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T20:23:59.757272-05:00","closed_at":"2026-01-29T20:23:59.757272-05:00","close_reason":"Mosaic demo cancelled — approach won't work. Archived in lokt beads.","labels":["demo","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-65w.1","depends_on_id":"lokt-65w","type":"parent-child","created_at":"2026-01-28T22:57:04.398984-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-65w.2","title":"DEMO verify:local mosaic completes with verifier pass","description":"## Check\nRun a small mosaic demo and confirm the verifier reports all invariants passing.\n\n## Command\n```bash\n./lokt demo mosaic --grid 8x8 --workers 16 --ttl 2s --seed 42 --fps 0\n```\n\n## Expected\n- Mosaic completes (64 tiles)\n- Verifier: count=64, indices 0..63 unique, chain valid\n- Exit code 0","notes":"env: local\nverify: agent\nmaps-to-ac: correctness, verifier","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:57:04.545102-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T20:23:59.763712-05:00","closed_at":"2026-01-29T20:23:59.763712-05:00","close_reason":"Mosaic demo cancelled — approach won't work. Archived in lokt beads.","labels":["demo","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-65w.2","depends_on_id":"lokt-65w","type":"parent-child","created_at":"2026-01-28T22:57:04.546895-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-65w.3","title":"DEMO verify:local deterministic seed produces identical output","description":"## Check\nSame seed produces identical tile colors across two runs.\n\n## Command\n```bash\n# Run twice with same seed, compare ledger rgb values\n./lokt demo mosaic --grid 4x4 --workers 4 --seed 1337 --fps 0\ncp \u003cledger1\u003e /tmp/ledger1.jsonl\n./lokt demo mosaic --grid 4x4 --workers 4 --seed 1337 --fps 0\n# Compare rgb arrays from both ledgers (sorted by index)\n```\n\n## Expected\n- RGB values for each tile index are identical between runs","notes":"env: local\nverify: agent\nmaps-to-ac: determinism","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:57:04.696025-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T20:23:59.771631-05:00","closed_at":"2026-01-29T20:23:59.771631-05:00","close_reason":"Mosaic demo cancelled — approach won't work. Archived in lokt beads.","labels":["demo","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-65w.3","depends_on_id":"lokt-65w","type":"parent-child","created_at":"2026-01-28T22:57:04.706602-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-65w.4","title":"DEMO verify:local nolock mode shows corruption","description":"## Check\nRunning with --mode nolock produces detectable corruption.\n\n## Command\n```bash\n./lokt demo mosaic --grid 8x8 --workers 32 --mode nolock --seed 42 --fps 0\n```\n\n## Expected\n- Verifier detects at least one invariant failure (duplicate index, broken chain, or missing tile)\n- Exit code non-zero\n- Failure summary printed","notes":"env: local\nverify: agent\nmaps-to-ac: nolock contrast","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:57:04.86662-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T20:23:59.776929-05:00","closed_at":"2026-01-29T20:23:59.776929-05:00","close_reason":"Mosaic demo cancelled — approach won't work. Archived in lokt beads.","labels":["demo","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-65w.4","depends_on_id":"lokt-65w","type":"parent-child","created_at":"2026-01-28T22:57:04.886736-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-65w.5","title":"DEMO verify:local visual TUI renders correctly","description":"## Check\nVisual inspection of the terminal UI during a demo run.\n\n## Steps\n1. Run `lokt demo mosaic --grid 16x16 --workers 64 --ttl 2s --seed 42`\n2. Observe colored tile grid filling in real-time\n3. Observe sidebar stats updating\n4. Press 'f' to freeze, observe pause\n5. Press 'u' to unfreeze, observe resume\n6. Press 'q' to quit, observe clean terminal restore\n\n## Expected\n- Grid fills smoothly left-to-right, top-to-bottom\n- Colors are vivid and distinct\n- Sidebar shows live stats\n- Freeze/unfreeze keyboard shortcuts work\n- Terminal restored on quit (no raw mode artifacts)","notes":"env: local\nverify: human\nmaps-to-ac: renderer, keyboard, visual","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:57:05.031274-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T20:23:59.782808-05:00","closed_at":"2026-01-29T20:23:59.782808-05:00","close_reason":"Mosaic demo cancelled — approach won't work. Archived in lokt beads.","labels":["demo","verification","verify-human"],"dependencies":[{"issue_id":"lokt-65w.5","depends_on_id":"lokt-65w","type":"parent-child","created_at":"2026-01-28T22:57:05.033199-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-6cn","title":"Add exit code contract test (table-driven)","description":"Create a table-driven test that systematically verifies every exit code path in the CLI: lock held by other, lock not found, lock expired, timeout reached, frozen, corrupt file. Each scenario should exercise the CLI command and assert the specific exit code. This serves as documentation-as-tests and catches regressions if the CLI layer is ever refactored. Cover: lock, unlock, guard, freeze, unfreeze commands. Ref: external technical review — test plan item 6.","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:01:19.839336-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:01:19.839336-05:00","labels":["test"]}
{"id":"lokt-7au","title":"L-172 audit-tail","description":"## Summary\nAdd `--tail` flag to `lokt audit` command for real-time monitoring of audit events. Operators can watch lock activity live during debugging.\n\n## Acceptance Criteria\n- [ ] **Tail mode**: Given `--tail` flag, when new events are appended to audit.log, then they are printed to stdout immediately\n- [ ] **Name filter in tail**: Given `--tail --name build`, when events are appended, then only \"build\" lock events are printed\n- [ ] **Graceful shutdown**: Given tail mode running, when SIGINT received, then process exits cleanly with exit 0\n- [ ] **Missing file**: Given `--tail` when audit.log doesn't exist, then wait for file creation and start tailing\n- [ ] **File rotation**: Given tail mode, when audit.log is truncated, then continue reading from beginning of new content\n- [ ] **Usage exclusive**: Given `--since` and `--tail` together, then show error (mutually exclusive)\n\n## Plan\n\n### Strategy\nAdd tail functionality as a separate code path in cmdAudit. Use simple polling (no fsnotify dependency) with file stat checks to detect new content, truncation, and file recreation.\n\n### Patterns\n- Mirror: `cmd/lokt/main.go:144` — signal.NotifyContext for graceful shutdown\n- Mirror: `cmd/lokt/main.go:655` — existing cmdAudit structure\n- Reuse: existing auditEvent struct and JSON parsing\n\n### Key Decisions\n- Simple polling (200ms interval) over fsnotify: avoids new dependency, sufficient for audit use case\n- Mutually exclusive --since and --tail: simplifies implementation, clear user intent\n- Exit 0 on SIGINT: clean shutdown is success, not error\n\n## Edge Cases\n- Audit log doesn't exist yet — wait for creation, then start tailing\n- Audit log is truncated (rotated) — detect via file size decrease, seek to beginning\n- Audit log is deleted — handle gracefully, wait for recreation\n- Very fast writes — buffer appropriately, don't miss events\n- Malformed JSON line — skip and continue (same as batch mode)\n\n## Constraints\n- Mirror signal handling patterns in guard command\n- Keep CLI consistent with existing flags\n- Poll interval 200ms to balance responsiveness and CPU\n- Use existing auditEvent struct for parsing","notes":"source: _notes/story-drafts/l-172-audit-tail.md\nverify-level: optional\nverify-envs: local","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T23:08:52.6868-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T08:52:37.516689-05:00","closed_at":"2026-01-28T08:52:37.516689-05:00","close_reason":"All tasks complete. Commit 0b254a1. Tests passing.","labels":["L-172","story"]}
{"id":"lokt-7au.1","title":"L-172 cli: add --tail flag and validation","description":"## What\nAdd --tail flag to cmdAudit and validate mutual exclusivity with --since.\n\n## Why\n--tail and --since are different modes: --since is batch query, --tail is follow mode. Combining them is confusing.\n\n## Pattern\nMirror: `cmd/lokt/main.go:656-666` — existing flag parsing and validation\n\n## Acceptance\n- [ ] --tail bool flag added to audit command\n- [ ] If --tail and --since both specified, show error and exit with ExitUsage\n- [ ] Usage message updated to show --tail option\n- [ ] If neither --since nor --tail, show usage (one required)","notes":"env: local\nverify: agent\nmaps-to-ac: usage-exclusive","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T23:09:16.246937-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T08:47:15.025507-05:00","closed_at":"2026-01-28T08:47:15.025507-05:00","close_reason":"Added --tail flag, mutual exclusivity validation with --since, updated usage message. Stub for cmdAuditTail added.","labels":["L-172","task"],"dependencies":[{"issue_id":"lokt-7au.1","depends_on_id":"lokt-7au","type":"parent-child","created_at":"2026-01-27T23:09:16.252459-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7au.2","title":"L-172 cli: implement tail loop with polling","description":"## What\nImplement the tail follow loop using polling approach.\n\n## Why\nCore functionality: continuously read new lines from audit.log and print them.\n\n## Pattern\nMirror: `cmd/lokt/main.go:144` — signal.NotifyContext for graceful shutdown\nMirror: `cmd/lokt/main.go:694-719` — line reading and JSON parsing\n\n## Acceptance\n- [ ] Tail loop polls every 200ms for new content\n- [ ] New lines are parsed as JSON and printed to stdout\n- [ ] --name filter works in tail mode (same as batch mode)\n- [ ] Malformed lines are skipped silently\n- [ ] SIGINT/SIGTERM triggers clean exit with exit 0\n- [ ] Context cancellation breaks the poll loop","notes":"env: local\nverify: agent\nmaps-to-ac: tail-mode,name-filter,graceful-shutdown","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T23:09:18.507789-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T08:48:25.757812-05:00","closed_at":"2026-01-28T08:48:25.757812-05:00","close_reason":"Implemented tailAuditLog with 200ms polling, signal handling (exit 0 on SIGINT/SIGTERM), name filter, malformed line skipping.","labels":["L-172","task"],"dependencies":[{"issue_id":"lokt-7au.2","depends_on_id":"lokt-7au","type":"parent-child","created_at":"2026-01-27T23:09:18.51466-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7au.2","depends_on_id":"lokt-7au.1","type":"blocks","created_at":"2026-01-27T23:09:29.620283-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7au.3","title":"L-172 cli: handle missing file and rotation","description":"## What\nHandle edge cases: missing file (wait for creation) and file truncation (rotation).\n\n## Why\nProduction reliability: audit log may not exist initially, and log rotation should not break tailing.\n\n## Pattern\n- os.Stat to check file existence and size\n- Compare current size to last read position for truncation detection\n\n## Acceptance\n- [ ] If audit.log doesn't exist, poll for creation (200ms) until file appears\n- [ ] If file size decreases (truncation), seek to beginning and continue\n- [ ] If file is deleted while tailing, wait for recreation\n- [ ] No panic or error on any file state transition","notes":"env: local\nverify: agent\nmaps-to-ac: missing-file,file-rotation","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T23:09:20.913136-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T08:48:29.188962-05:00","closed_at":"2026-01-28T08:48:29.188962-05:00","close_reason":"Edge cases implemented in tailAuditLog: waits for file creation, detects truncation via size comparison, handles deletion by waiting for recreation.","labels":["L-172","task"],"dependencies":[{"issue_id":"lokt-7au.3","depends_on_id":"lokt-7au","type":"parent-child","created_at":"2026-01-27T23:09:20.918964-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7au.3","depends_on_id":"lokt-7au.2","type":"blocks","created_at":"2026-01-27T23:09:29.766876-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7au.4","title":"L-172 test: add audit tail tests","description":"## What\nAdd unit tests for audit --tail functionality.\n\n## Why\nVerify tail behavior: polling, filtering, signal handling, edge cases.\n\n## Pattern\nMirror: existing test patterns in cmd/lokt/main_test.go or internal/audit/audit_test.go\n\n## Acceptance\n- [ ] Test tail outputs new events as they're written\n- [ ] Test --name filter in tail mode\n- [ ] Test mutual exclusivity error for --since + --tail\n- [ ] Test graceful shutdown on context cancel\n- [ ] Test file creation wait\n- [ ] Test truncation detection","notes":"env: local\nverify: agent\nmaps-to-ac: all","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T23:09:22.961435-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T08:50:25.792307-05:00","closed_at":"2026-01-28T08:50:25.792307-05:00","close_reason":"Added 6 unit tests: OutputsNewEvents, NameFilter, GracefulShutdown, WaitsForFileCreation, DetectsTruncation, SkipsMalformedLines. All tests pass.","labels":["L-172","task"],"dependencies":[{"issue_id":"lokt-7au.4","depends_on_id":"lokt-7au","type":"parent-child","created_at":"2026-01-27T23:09:22.969155-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7au.4","depends_on_id":"lokt-7au.3","type":"blocks","created_at":"2026-01-27T23:09:29.915781-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7iv","title":"L-142 backoff-jitter","description":"## Summary\nReplace fixed 100ms polling with exponential backoff + jitter to prevent thundering herd.\n\n## Acceptance Criteria\n- [ ] Initial poll ~50-100ms (fast first retry)\n- [ ] Exponential growth with each retry\n- [ ] Random jitter to desynchronize waiters\n- [ ] Max interval capped at ~2s\n- [ ] Existing tests still pass\n\n## Plan\n\n### Strategy\nModify `AcquireWithWait` to use exponential backoff with jitter instead of fixed ticker.\n\n### Parameters\n- Base: 50ms\n- Max: 2s  \n- Jitter: ±25%\n- Formula: `min(base * 2^attempt, max) * (0.75 + rand*0.5)`","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T15:43:05.269165-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T15:46:35.367746-05:00","closed_at":"2026-01-27T15:46:35.367746-05:00","close_reason":"L-142 complete"}
{"id":"lokt-7iv.1","title":"L-142 lock: add backoff + jitter","description":"## What\nReplace fixed 100ms ticker with exponential backoff + jitter in AcquireWithWait.\n\n## Implementation\n```go\nconst (\n    baseInterval = 50 * time.Millisecond\n    maxInterval  = 2 * time.Second\n)\n\nfunc backoffInterval(attempt int) time.Duration {\n    interval := baseInterval * time.Duration(1\u003c\u003cuint(attempt))\n    if interval \u003e maxInterval {\n        interval = maxInterval\n    }\n    // Add jitter: ±25%\n    jitter := 0.75 + rand.Float64()*0.5\n    return time.Duration(float64(interval) * jitter)\n}\n```\n\n## Acceptance\n- [ ] Replace ticker with backoff loop\n- [ ] Jitter randomizes intervals\n- [ ] Max capped at 2s\n- [ ] All existing tests pass","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T15:43:19.800102-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T15:46:35.217357-05:00","closed_at":"2026-01-27T15:46:35.217357-05:00","close_reason":"Added exponential backoff (50ms-2s) with ±25% jitter. Commit: 8e371ea","dependencies":[{"issue_id":"lokt-7iv.1","depends_on_id":"lokt-7iv","type":"parent-child","created_at":"2026-01-27T15:43:19.805043-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7op","title":"DEMO: Terminal Mosaic demo command","description":"## Summary\nImplement `lokt demo mosaic` — a visually impressive terminal demo that proves Lokt correctness under extreme concurrency. Workers race to fill a colored tile grid through Lokt locks, with a live ANSI TUI showing progress, lock contention stats, freeze/crash recovery events.\n\n## Acceptance Criteria\n- [ ] `lokt demo mosaic` command fills a grid deterministically (no gaps, no dupes)\n- [ ] Real-time terminal renderer shows colored tile grid + sidebar stats at configurable FPS\n- [ ] Workers use Lokt locking (single-phase protocol with guard-like semantics)\n- [ ] Append-only JSONL ledger with SHA256 hash chain for corruption detection\n- [ ] End-of-run verifier checks all invariants (count, contiguity, chain, uniqueness)\n- [ ] Keyboard shortcuts: f=freeze, u=unfreeze, k=kill holder, q=quit\n- [ ] `--mode nolock` contrast mode shows visible failures\n- [ ] Configurable: grid size, workers, TTL, FPS, tile-delay, seed\n\n## Edge Cases\n- Renderer must tolerate partial writes (read only complete newline-terminated JSON)\n- Cleanup on SIGINT: stop workers, restore terminal (raw mode)\n- Hash chain GENESIS anchor for first entry\n- Workers must handle context cancellation gracefully\n- No-lock mode: ledger corruption is expected and detected\n\n## Constraints\n- No external dependencies (stdlib + existing internal packages only)\n- Workers are goroutines (not subprocesses) for v1\n- Single-phase protocol: claim+commit under one lock for strict sequential fill\n- Use existing internal/lock, internal/audit, internal/root packages","notes":"source: _notes/story-drafts/demo.md\nverify-level: agent+human\nverify-envs: local\nverify-epic: lokt-65w\n\n## Plan\n\n### Strategy\nBuild the demo in layers: data contract first (ledger/verifier), then workers (concurrency engine), then renderer (visual output), then CLI glue, then chaos modes. Each layer is independently testable.\n\n### Patterns\n- Mirror: internal/audit/audit.go — append-only JSONL for ledger\n- Mirror: internal/lockfile/lockfile.go — atomic file I/O with fsync\n- Mirror: cmd/lokt/main.go cmdGuard() — acquire/release with heartbeat, signal handling\n- Mirror: cmd/lokt/main.go cmdAuditTail() — file tailing with truncation detection\n- Convention: stdlib flag package (no cobra), switch-case command dispatch\n\n### Key Decisions\n- Single-phase protocol: claim+commit under one lock for strict sequential fill (simpler, still exercises TTL/renew)\n- Goroutines not subprocesses: sufficient for v1, simpler coordination, same lock contention\n- No external TUI library: raw ANSI sequences for zero dependencies\n- Ledger-driven renderer: reads from ledger file, not from worker channels (proves append-only correctness)\n- Hash chain with SHA256: overkill for demo but proves integrity dramatically","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:55:21.581505-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T23:36:45.84277-05:00","closed_at":"2026-01-28T23:36:45.84277-05:00","close_reason":"All 5 subtasks implemented and tested. Demo mosaic command works with lock and nolock modes."}
{"id":"lokt-7op.1","title":"DEMO core: ledger, tile color, hash chain, verifier","description":"## What\nImplement the foundational data layer for the mosaic demo:\n1. Ledger format (JSONL append with SHA256 hash chain)\n2. Deterministic tile color generation (splitmix64 seed → RGB)\n3. Next-index atomic counter file\n4. End-of-run verifier (count, uniqueness, contiguity, chain integrity)\n\n## Why\nEverything else (workers, renderer) depends on this data contract being defined and testable.\n\n## Pattern\nMirror: `internal/audit/audit.go` — append-only JSONL with structured types.\nMirror: `internal/lockfile/lockfile.go` — atomic file I/O with fsync.\n\n## Acceptance\n- [ ] `internal/demo/ledger.go`: LedgerEntry struct with JSON tags, Append() with hash chain\n- [ ] `internal/demo/color.go`: TileColor(i, seed) → [3]byte RGB using splitmix64\n- [ ] `internal/demo/state.go`: MosaicState with next-index file read/write under lock\n- [ ] `internal/demo/verify.go`: VerifyLedger() checks count, uniqueness, contiguity, chain\n- [ ] Unit tests for color determinism and verifier","notes":"env: local\nverify: agent\nmaps-to-ac: ledger, verifier, deterministic colors","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:55:35.172022-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T23:36:39.217305-05:00","closed_at":"2026-01-28T23:36:39.217311-05:00","dependencies":[{"issue_id":"lokt-7op.1","depends_on_id":"lokt-7op","type":"parent-child","created_at":"2026-01-28T22:55:35.174316-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7op.2","title":"DEMO workers: goroutine pool with single-phase locking","description":"## What\nImplement the worker pool that fills the mosaic:\n1. Worker goroutine loop: acquire lock → read next-index → compute RGB → append ledger → release lock → jitter sleep\n2. Coordinator: spawn N workers, distribute context, collect completion\n3. Use internal/lock.Acquire + Release with audit events\n4. Graceful shutdown on context cancellation\n\n## Why\nWorkers are the core concurrency engine. They exercise Lokt's locking under realistic contention.\n\n## Pattern\nMirror: guard command (cmd/lokt/main.go:348-526) — acquire/release with heartbeat, signal handling.\nMirror: internal/lock/acquire.go — AcquireWithWait for --wait mode.\n\n## Acceptance\n- [ ] `internal/demo/worker.go`: Worker struct with Run(ctx) loop\n- [ ] `internal/demo/coordinator.go`: Start(ctx, config) spawns workers, waits for completion or cancel\n- [ ] Workers use lock.Acquire/Release with audit.Writer\n- [ ] Workers respect --wait/--timeout flags\n- [ ] Workers stop cleanly on context cancel (no leaked goroutines)\n- [ ] --tile-delay jitter between iterations","notes":"env: local\nverify: agent\nmaps-to-ac: workers, locking, contention","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:55:47.133652-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T23:36:39.370584-05:00","closed_at":"2026-01-28T23:36:39.370591-05:00","dependencies":[{"issue_id":"lokt-7op.2","depends_on_id":"lokt-7op","type":"parent-child","created_at":"2026-01-28T22:55:47.136468-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7op.2","depends_on_id":"lokt-7op.1","type":"blocks","created_at":"2026-01-28T22:56:32.931452-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7op.3","title":"DEMO renderer: ANSI truecolor TUI with sidebar stats","description":"## What\nImplement the terminal renderer:\n1. Tail ledger.jsonl incrementally (seek + read new bytes)\n2. Render GY rows × GX cols grid using ANSI truecolor backgrounds (`ESC[48;2;R;G;Bm  ESC[0m`)\n3. Sidebar: progress, rate, lock contention p50/p95, holder info, freeze indicator, recent events\n4. Poll `lokt status --json` periodically for holder/expiry info\n5. Raw terminal mode for keyboard input (f/u/k/q shortcuts)\n6. Restore terminal on exit\n\n## Why\nThe visual output is the entire point of the demo — it makes correctness obvious at a glance.\n\n## Pattern\nMirror: audit --tail (cmd/lokt/main.go:938-1078) — file tailing with truncation detection.\nNo external TUI library — use raw ANSI sequences for zero dependencies.\n\n## Acceptance\n- [ ] `internal/demo/renderer.go`: Renderer with Start(ctx) loop at configurable FPS\n- [ ] Grid renders with ANSI truecolor backgrounds (2-char wide cells)\n- [ ] Unset tiles show dark gray\n- [ ] Sidebar shows: tiles done/total, rate, holder, freeze status, recent events\n- [ ] Keyboard input: f=freeze, u=unfreeze, k=kill holder, q=quit\n- [ ] Terminal restored to normal on exit (deferred cleanup)\n- [ ] Handles terminal resize gracefully (or at least doesn't crash)","notes":"env: local\nverify: agent+human\nmaps-to-ac: renderer, sidebar, keyboard","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:56:02.241382-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T23:36:39.517395-05:00","closed_at":"2026-01-28T23:36:39.5174-05:00","dependencies":[{"issue_id":"lokt-7op.3","depends_on_id":"lokt-7op","type":"parent-child","created_at":"2026-01-28T22:56:02.24338-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7op.3","depends_on_id":"lokt-7op.1","type":"blocks","created_at":"2026-01-28T22:56:33.101934-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7op.4","title":"DEMO CLI: command entry point, flags, orchestration","description":"## What\nWire everything together:\n1. Add `case \"demo\": code = cmdDemo(args)` in main.go switch\n2. Parse subcommand: `demo mosaic` (allow future demo types)\n3. Parse all flags: --name, --grid, --tile, --workers, --ttl, --wait, --timeout, --fps, --tile-delay, --chunk-size, --chunk-delay, --seed, --mode\n4. Initialize: root discovery, audit writer, demo directory, state file\n5. Orchestrate: start renderer → start workers → wait for completion or quit → run verifier → print summary\n6. Handle SIGINT/SIGTERM: stop workers, flush ledger, run verifier, restore terminal\n\n## Why\nThe entry point ties all components together and provides the user-facing CLI experience.\n\n## Pattern\nMirror: cmdGuard() (main.go:348-526) — flag parsing, context setup, signal handling.\nAdd `demo` to usage() help text.\n\n## Acceptance\n- [ ] `lokt demo mosaic` runs with all documented flags\n- [ ] `lokt demo --help` shows usage\n- [ ] Creates `\u003cLOKT_ROOT\u003e/demo/mosaic/` directory with state/ledger files\n- [ ] End-of-run summary: total tiles, duration, rate, pass/fail\n- [ ] Non-zero exit on verification failure\n- [ ] Cleanup: removes lock on exit, restores terminal","notes":"env: local\nverify: agent\nmaps-to-ac: CLI, flags, orchestration, cleanup","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:56:16.124349-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T23:36:39.65567-05:00","closed_at":"2026-01-28T23:36:39.655674-05:00","dependencies":[{"issue_id":"lokt-7op.4","depends_on_id":"lokt-7op","type":"parent-child","created_at":"2026-01-28T22:56:16.129217-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7op.4","depends_on_id":"lokt-7op.1","type":"blocks","created_at":"2026-01-28T22:56:33.25537-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7op.4","depends_on_id":"lokt-7op.2","type":"blocks","created_at":"2026-01-28T22:56:33.420146-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7op.4","depends_on_id":"lokt-7op.3","type":"blocks","created_at":"2026-01-28T22:56:33.576946-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-7op.5","title":"DEMO nolock mode + chaos scenarios","description":"## What\nImplement contrast and chaos modes:\n1. `--mode nolock`: workers skip locking, causing visible corruption (duplicate indices, broken hash chain)\n2. Freeze demo scenario: auto-freeze at configurable % completion\n3. Crash recovery: kill holder via keyboard shortcut, observe auto-prune\n4. Timeout pressure: subset of workers with tight --timeout\n\n## Why\nThese scenarios make the demo dramatically more impressive and prove Lokt's value by showing what happens without it.\n\n## Pattern\nMirror: freeze/unfreeze commands (cmd/lokt/main.go:740-776).\nMirror: status --json parsing for kill-holder feature.\n\n## Acceptance\n- [ ] `--mode nolock` bypasses locking, corruption detected by verifier\n- [ ] `f` key triggers freeze with configurable TTL\n- [ ] `k` key finds holder PID via status --json and sends SIGKILL\n- [ ] Verifier prints detailed failure summary in nolock mode\n- [ ] Events stream shows deny/freeze-deny/auto-prune in renderer sidebar","notes":"env: local\nverify: agent+human\nmaps-to-ac: nolock mode, freeze, crash recovery, chaos","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:56:27.298567-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T23:36:39.805461-05:00","closed_at":"2026-01-28T23:36:39.805465-05:00","dependencies":[{"issue_id":"lokt-7op.5","depends_on_id":"lokt-7op","type":"parent-child","created_at":"2026-01-28T22:56:27.303403-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-7op.5","depends_on_id":"lokt-7op.4","type":"blocks","created_at":"2026-01-28T22:56:33.733901-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-8s7","title":"L-202 doctor-health-check","description":"## Summary\nPre-flight validation command `lokt doctor` that checks:\n- Directory writability (actual file create/write/delete)\n- Network filesystem detection (NFS/CIFS warning)\n- Clock sanity (year range check)\n- Root discovery reporting (method + path)\n\n## Acceptance Criteria\n- [ ] Writability check: creates test file, writes, removes, reports OK\n- [ ] Network FS detection: warns on NFS/CIFS with explanation\n- [ ] Clock sanity: OK for reasonable clock, warn if year \u003c 2020 or \u003e 2100\n- [ ] Root discovery: reports method (LOKT_ROOT/git/.lokt) and path\n- [ ] Exit codes: 0 if pass, 1 if critical failure, 0 with warnings printed\n- [ ] JSON output: `--json` flag for CI integration\n\n## Plan\n\n### Strategy\nAdd new `doctor` command following existing `cmdX` patterns. Create `internal/doctor` package with platform-specific network FS detection using build tags (mirror `internal/stale` approach).\n\n### Patterns\n- Mirror: `cmd/lokt/main.go:cmdStatus` — JSON output flag pattern\n- Mirror: `internal/stale/process_unix.go` — platform-specific build tags\n- Mirror: `internal/root/root.go` — extend to expose discovery method\n\n### Key Decisions\n- Writability test: create .lokt-doctor-test file, write, fsync, remove\n- Network FS: use statfs syscall on Unix, fallback to unknown on Windows\n- Clock sanity: simple year range check (2020-2100)\n- Exit code: warnings don't cause non-zero exit (informational only)\n\n## Edge Cases\n- No root found: report discovery would-be method, note dir doesn't exist\n- Permission denied: clear message distinguishing from disk full\n- Symlinked dirs: follow symlinks for FS detection\n- Containers: clock check works regardless of container isolation\n\n## Constraints\n- No new dependencies (stdlib only)\n- Cross-platform (macOS, Linux, Windows)\n- Idempotent (clean up test files)\n- Fast (\u003c 1 second)","notes":"source: _notes/story-drafts/l-202-doctor-health-check.md\nverify-level: optional\nverify-envs: sandbox","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:30:08.71355-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:46:56.469814-05:00","closed_at":"2026-01-28T09:46:56.469814-05:00","close_reason":"L-202 complete: lokt doctor command implemented and verified","labels":["L-202","story"]}
{"id":"lokt-8s7.1","title":"L-202 root: add FindWithMethod for discovery reporting","description":"## What\nExtend `internal/root` to expose which discovery method was used (LOKT_ROOT env, git, .lokt/).\n\n## Why\nDoctor needs to report how root was discovered, not just the path.\n\n## Pattern\nMirror: `internal/root/root.go:Find()` — add parallel `FindWithMethod()` that returns both path and method enum.\n\n## Acceptance\n- [ ] Add `DiscoveryMethod` type (EnvVar, Git, LocalDir)\n- [ ] Add `FindWithMethod() (string, DiscoveryMethod, error)` function\n- [ ] Existing `Find()` unchanged (call FindWithMethod internally)\n- [ ] Unit test for each discovery method","notes":"env: local\nverify: agent\nmaps-to-ac: Root discovery reporting","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:30:29.588965-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:33:39.414636-05:00","closed_at":"2026-01-28T09:33:39.414636-05:00","close_reason":"Added FindWithMethod() with DiscoveryMethod type and tests","labels":["L-202","task"],"dependencies":[{"issue_id":"lokt-8s7.1","depends_on_id":"lokt-8s7","type":"parent-child","created_at":"2026-01-28T09:30:29.594504-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-8s7.2","title":"L-202 doctor: add internal/doctor package with checks","description":"## What\nCreate `internal/doctor` package with health check implementations:\n- Writability check (create/write/remove test file)\n- Clock sanity check (year range)\n- Network FS detection (platform-specific)\n\n## Why\nCentralizes health check logic for reuse and testing.\n\n## Pattern\nMirror: `internal/stale/` — platform-specific files with build tags\n\n## Acceptance\n- [ ] `CheckWritable(dir string) CheckResult` — creates .lokt-doctor-test, writes, removes\n- [ ] `CheckClock() CheckResult` — warns if year \u003c 2020 or \u003e 2100\n- [ ] `CheckNetworkFS(path string) CheckResult` — platform-specific detection\n- [ ] `CheckResult` type with Status (ok/warn/fail), Message, Details\n- [ ] Unit tests for each check","notes":"env: local\nverify: agent\nmaps-to-ac: Writability check, Clock sanity, Network FS detection","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:30:33.672632-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:35:48.430771-05:00","closed_at":"2026-01-28T09:35:48.430771-05:00","close_reason":"Created internal/doctor package with CheckWritable, CheckClock, CheckNetworkFS (platform-specific), tests passing","labels":["L-202","task"],"dependencies":[{"issue_id":"lokt-8s7.2","depends_on_id":"lokt-8s7","type":"parent-child","created_at":"2026-01-28T09:30:33.679499-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-8s7.3","title":"L-202 cli: add doctor command with --json flag","description":"## What\nAdd `lokt doctor` command to CLI that runs all health checks and reports results.\n\n## Why\nUser-facing entry point for health validation.\n\n## Pattern\nMirror: `cmd/lokt/main.go:cmdStatus` — JSON output flag, structured output\n\n## Acceptance\n- [ ] `lokt doctor` runs all checks, prints text report\n- [ ] `lokt doctor --json` outputs JSON with root_method, root_path, checks[], overall\n- [ ] Exit 0 if all pass or only warnings\n- [ ] Exit 1 if any critical failure (not writable)\n- [ ] Usage shown in `lokt help`","notes":"env: local\nverify: agent\nmaps-to-ac: Exit codes, JSON output","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:30:37.507213-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:38:32.208067-05:00","closed_at":"2026-01-28T09:38:32.208067-05:00","close_reason":"Added lokt doctor command with --json flag, proper exit codes, all tests passing","labels":["L-202","task"],"dependencies":[{"issue_id":"lokt-8s7.3","depends_on_id":"lokt-8s7","type":"parent-child","created_at":"2026-01-28T09:30:37.524647-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-8s7.3","depends_on_id":"lokt-8s7.1","type":"blocks","created_at":"2026-01-28T09:30:45.606727-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-8s7.3","depends_on_id":"lokt-8s7.2","type":"blocks","created_at":"2026-01-28T09:30:45.854562-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-9l5","title":"lokt-al5 verify:sandbox frozen lock","description":"## Check\nlokt why reports freeze blocking correctly.\n\n## Commands\nlokt freeze test-frozen --ttl 5m\nlokt why test-frozen\nlokt unfreeze test-frozen\n\n## Expected\n- Output shows freeze owner, remaining TTL\n- Suggests waiting or unfreeze\n- Exit code 2","notes":"env: sandbox\nverify: agent\nmaps-to-ac: frozen","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:12:47.376392-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:22:44.76204-05:00","closed_at":"2026-01-28T22:22:44.76204-05:00","close_reason":"Verified: lokt why frozen-lock → FROZEN with owner + remaining TTL + suggestions, exit 2","dependencies":[{"issue_id":"lokt-9l5","depends_on_id":"lokt-pne","type":"blocks","created_at":"2026-01-28T22:12:54.256473-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-a0t","title":"L-188 verify:sandbox","description":"Verification for L-188 install-script\n\nLinked story: lokt-v03\n\n## Scope\n- Agent-verifiable: script syntax, OS detection, checksum logic\n- Human-verifiable: actual install on fresh system\n\n## Environments\nsandbox","notes":"linked-story: lokt-v03\nverify-level: optional","status":"closed","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T21:01:35.924282-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:54:36.234444-05:00","closed_at":"2026-01-28T22:54:36.234444-05:00","close_reason":"All tasks and verification complete. Install bugs fixed in 5280f65.","labels":["L-188","verification"]}
{"id":"lokt-a0t.1","title":"L-188 verify:sandbox shellcheck","description":"## Check\nRun shellcheck on install.sh to verify POSIX compliance.\n\n## Command\n```bash\nshellcheck -s sh scripts/install.sh\n```\n\n## Expected\nNo errors or warnings.","notes":"env: sandbox\nverify: agent\nmaps-to-ac: Basic install","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T21:01:46.14893-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T21:30:57.437012-05:00","closed_at":"2026-01-27T21:30:57.437012-05:00","close_reason":"shellcheck -s sh scripts/install.sh passes with no errors or warnings.","labels":["L-188","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-a0t.1","depends_on_id":"lokt-a0t","type":"parent-child","created_at":"2026-01-27T21:01:46.156192-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-a0t.2","title":"L-188 verify:sandbox manual install","description":"## Check\nTest install script on a fresh system (VM or container).\n\n## Steps\n1. Start fresh Linux container: docker run -it ubuntu:22.04\n2. Run: curl -fsSL https://raw.githubusercontent.com/nikolasavic/lokt/main/scripts/install.sh | sh\n3. Verify: lokt --version\n\n## Expected\n- lokt installed to ~/.local/bin or /usr/local/bin\n- lokt --version shows version info","notes":"env: sandbox\nverify: human\nmaps-to-ac: Basic install, Linux support","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T21:01:49.251488-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:54:22.130987-05:00","closed_at":"2026-01-28T22:54:22.130987-05:00","close_reason":"User verified manual install: script downloads, but found two bugs (upgrade-in-place + --version). Fixed in 5280f65.","labels":["L-188","verification","verify-human"],"dependencies":[{"issue_id":"lokt-a0t.2","depends_on_id":"lokt-a0t","type":"parent-child","created_at":"2026-01-27T21:01:49.257439-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-afw","title":"L-203 corrupted-lock-handling","description":"## Summary\nMalformed JSON in lock files should be treated as stale, not cause errors or crashes. Defensive parsing with clear audit logging.\n\n## Problem\nWhen a lock file contains corrupted/malformed JSON (e.g., partial write from a crash, disk corruption, manual editing), various code paths behave inconsistently:\n- `Acquire()` returns a synthetic HeldError (locks out everyone until TTL or manual cleanup)\n- `Release()` and `Renew()` bubble up opaque errors\n- `tryBreakStale()` silently returns false (corrupted file blocks --break-stale)\n- No audit trail for corrupted file encounters\n\n## Strategy\nMirror the L-201 auto-prune pattern: detect corruption, remove the file, emit an audit event, and continue. A corrupted lock file has no valid holder, so treating it as stale is safe — no process actually owns it.\n\n### Patterns\n- Mirror: `internal/lock/acquire.go:82-104` — auto-prune dead PID flow\n- Mirror: `internal/stale/stale.go` — Reason enum pattern\n- Mirror: `internal/audit/audit.go` — Event constant pattern\n\n### Key Decisions\n- New `ErrCorrupted` error type in lockfile package for structured detection\n- New `ReasonCorrupted` in stale.Reason enum\n- New `EventCorruptedBreak` audit event type\n- Corrupted files treated as unconditionally stale (no valid holder → safe to remove)\n- Acquire auto-prunes corrupted files (same as dead PID), Release with --break-stale/--force also handles them\n\n## Acceptance Criteria\n- [ ] Corrupted lock file during acquire is removed and lock is acquired\n- [ ] Corrupted lock file during release --break-stale is removed\n- [ ] Corrupted lock file during release --force is removed\n- [ ] Audit log records corrupted-break events with file path context\n- [ ] Normal release of corrupted file returns clear error (not owner-check crash)\n- [ ] tryBreakStale handles corrupted files (removes them)\n- [ ] Unit tests cover all corruption paths\n\n## Edge Cases\n- Empty file (0 bytes)\n- Partial JSON (truncated write)\n- Valid JSON but wrong schema (e.g., array instead of object)\n- Binary garbage\n- File disappears between existence check and read (race)\n\n## Constraints\n- Must not change behavior for valid lock files\n- Must not mask real I/O errors (permission denied, disk full)\n- Audit events must include enough context for debugging","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:10:37.182459-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:22:11.597832-05:00","closed_at":"2026-01-28T16:22:11.597832-05:00","close_reason":"Closed","labels":["L-203","story"]}
{"id":"lokt-afw.1","title":"L-203 stale+audit: add ReasonCorrupted and EventCorruptedBreak","description":"## What\nAdd new constants to the stale and audit packages for corrupted lock file handling.\n\n## Why\nNeed structured reason/event types to distinguish corrupted-file removal from other stale-break paths. Mirrors existing ReasonDeadPID/EventAutoPrune pattern.\n\n## Changes\n1. `internal/stale/stale.go`: Add `ReasonCorrupted Reason = \"corrupted\"`\n2. `internal/audit/audit.go`: Add `EventCorruptedBreak = \"corrupted-break\"`\n\n## Pattern\nMirror: `internal/stale/stale.go:10-14` — existing Reason constants\nMirror: `internal/audit/audit.go:13-21` — existing Event constants\n\n## Acceptance\n- [ ] ReasonCorrupted constant exists in stale package\n- [ ] EventCorruptedBreak constant exists in audit package\n- [ ] Existing constants unchanged","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:17.012982-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:16:12.868692-05:00","closed_at":"2026-01-28T16:16:12.868692-05:00","close_reason":"Closed","labels":["L-203","task"],"dependencies":[{"issue_id":"lokt-afw.1","depends_on_id":"lokt-afw","type":"parent-child","created_at":"2026-01-28T16:11:17.016983-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-afw.2","title":"L-203 lockfile: add ErrCorrupted sentinel error","description":"## What\nAdd a structured error type to the lockfile package so callers can distinguish JSON parse failures from other I/O errors.\n\n## Why\nCurrently `Read()` wraps JSON errors with `fmt.Errorf(\"invalid lock file: %w\", err)`. Callers cannot reliably distinguish corruption from permission errors or missing files. A typed error enables `errors.Is()` checks.\n\n## Changes\n1. `internal/lockfile/lockfile.go`: Add `ErrCorrupted = errors.New(\"corrupted lock file\")`\n2. `internal/lockfile/lockfile.go`: Change `Read()` to wrap JSON parse errors with `ErrCorrupted` instead of generic format string\n3. Update existing test `TestReadInvalidJSON` to assert `errors.Is(err, ErrCorrupted)`\n\n## Pattern\nMirror: `internal/lock/release.go:17-19` — sentinel error pattern (ErrNotFound, ErrNotOwner)\n\n## Acceptance\n- [ ] ErrCorrupted sentinel exists in lockfile package\n- [ ] lockfile.Read() returns ErrCorrupted-wrapped error on JSON parse failure\n- [ ] errors.Is(err, ErrCorrupted) returns true for malformed JSON\n- [ ] errors.Is(err, ErrCorrupted) returns false for missing file, permission errors\n- [ ] Existing TestReadInvalidJSON updated to check ErrCorrupted","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:19.647034-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:16:12.915768-05:00","closed_at":"2026-01-28T16:16:12.915768-05:00","close_reason":"Closed","labels":["L-203","task"],"dependencies":[{"issue_id":"lokt-afw.2","depends_on_id":"lokt-afw","type":"parent-child","created_at":"2026-01-28T16:11:19.658421-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-afw.3","title":"L-203 acquire: auto-prune corrupted lock files","description":"## What\nUpdate Acquire() and tryBreakStale() to treat corrupted lock files as stale — remove them and retry acquisition.\n\n## Why\nCurrently a corrupted lock file during acquire returns a synthetic HeldError, permanently blocking acquisition until manual cleanup or TTL. Since a corrupted file has no valid holder, it's safe to auto-prune.\n\n## Changes\n1. `internal/lock/acquire.go` in `Acquire()`: After `lockfile.Read()` fails, check if `errors.Is(readErr, lockfile.ErrCorrupted)`. If yes: remove the file, emit `EventCorruptedBreak` audit event, and retry acquisition (same pattern as dead-PID auto-prune at line 82).\n2. `internal/lock/acquire.go` in `tryBreakStale()`: After `lockfile.Read()` fails with ErrCorrupted, remove the file and return true.\n3. Keep existing behavior for non-corruption read errors (race condition during write → synthetic HeldError for retry).\n\n## Pattern\nMirror: `internal/lock/acquire.go:82-104` — dead PID auto-prune flow\n\n## Acceptance\n- [ ] Acquire() with corrupted lock file succeeds (removes corrupt file, acquires lock)\n- [ ] Acquire() emits corrupted-break audit event\n- [ ] tryBreakStale() removes corrupted lock files\n- [ ] Non-corruption read errors still return synthetic HeldError (race safety)\n- [ ] Real I/O errors (permission denied) not treated as corruption","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:22.46111-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:18:41.98519-05:00","closed_at":"2026-01-28T16:18:41.98519-05:00","close_reason":"Closed","labels":["L-203","task"],"dependencies":[{"issue_id":"lokt-afw.3","depends_on_id":"lokt-afw","type":"parent-child","created_at":"2026-01-28T16:11:22.468078-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-afw.3","depends_on_id":"lokt-afw.1","type":"blocks","created_at":"2026-01-28T16:11:36.984862-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-afw.3","depends_on_id":"lokt-afw.2","type":"blocks","created_at":"2026-01-28T16:11:37.165783-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-afw.4","title":"L-203 release: handle corrupted files in break-stale and force paths","description":"## What\nUpdate Release() to handle corrupted lock files in --break-stale and --force paths instead of returning opaque errors.\n\n## Why\nCurrently Release() returns `fmt.Errorf(\"read lock: %w\", err)` for any read error including corruption. With --break-stale, the user explicitly wants to remove stale locks — a corrupted file is definitionally stale. With --force, the user wants unconditional removal.\n\n## Changes\n1. `internal/lock/release.go` in `Release()`: After `lockfile.Read()` fails, check `errors.Is(err, lockfile.ErrCorrupted)`:\n   - If `opts.Force`: remove file, emit audit event, return nil\n   - If `opts.BreakStale`: remove file, emit audit event, return nil\n   - Otherwise (normal release): return clear error message indicating corruption\n\n## Pattern\nMirror: `internal/lock/release.go:85-112` — existing release mode switch\n\n## Acceptance\n- [ ] release --force removes corrupted lock file without error\n- [ ] release --break-stale removes corrupted lock file without error\n- [ ] Normal release of corrupted file returns descriptive error\n- [ ] Audit events emitted for corrupted-break removals\n- [ ] Non-corruption I/O errors still bubble up","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:24.838031-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:18:42.021386-05:00","closed_at":"2026-01-28T16:18:42.021386-05:00","close_reason":"Closed","labels":["L-203","task"],"dependencies":[{"issue_id":"lokt-afw.4","depends_on_id":"lokt-afw","type":"parent-child","created_at":"2026-01-28T16:11:24.844394-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-afw.4","depends_on_id":"lokt-afw.1","type":"blocks","created_at":"2026-01-28T16:11:37.362166-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-afw.4","depends_on_id":"lokt-afw.2","type":"blocks","created_at":"2026-01-28T16:11:37.560472-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-afw.5","title":"L-203 test: add corruption handling tests","description":"## What\nAdd comprehensive unit tests for corrupted lock file handling across all modified paths.\n\n## Why\nEnsure L-203 behavior is verified and regression-proof. Each corruption scenario needs coverage.\n\n## Test Cases\n1. `lockfile_test.go`: ErrCorrupted for empty file, partial JSON, binary garbage, wrong schema\n2. `acquire_test.go`: Acquire succeeds when existing lock is corrupted (auto-prune path)\n3. `acquire_test.go`: Acquire emits corrupted-break audit event\n4. `acquire_test.go`: tryBreakStale removes corrupted files\n5. `release_test.go`: Release --break-stale removes corrupted file\n6. `release_test.go`: Release --force removes corrupted file\n7. `release_test.go`: Normal release returns error for corrupted file\n\n## Pattern\nMirror: `internal/lock/acquire_test.go:466-715` — auto-prune test patterns\nMirror: `internal/lockfile/lockfile_test.go:89-101` — existing invalid JSON test\n\n## Acceptance\n- [ ] All test cases listed above pass\n- [ ] go test ./... passes\n- [ ] golangci-lint run passes","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:11:27.264911-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:21:39.118126-05:00","closed_at":"2026-01-28T16:21:39.118126-05:00","close_reason":"Closed","labels":["L-203","task"],"dependencies":[{"issue_id":"lokt-afw.5","depends_on_id":"lokt-afw","type":"parent-child","created_at":"2026-01-28T16:11:27.269616-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-afw.5","depends_on_id":"lokt-afw.3","type":"blocks","created_at":"2026-01-28T16:11:37.773394-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-afw.5","depends_on_id":"lokt-afw.4","type":"blocks","created_at":"2026-01-28T16:11:38.016493-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-al5","title":"Add lokt why \u003cname\u003e command","description":"Add a 'lokt why \u003cname\u003e' command that prints exactly why a lock cannot be acquired. Should cover all denial reasons: frozen, held by another owner, stale but not breakable (cross-host, no TTL), timeout reached, etc. Display parsed metadata (owner, host, PID, acquired time) and remaining TTL. This is a UX feature — the data already exists in lock/freeze files and stale detection; this is mostly formatting and a new CLI entrypoint. Ref: external technical review.","status":"closed","priority":1,"issue_type":"feature","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:00:52.5087-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:22:53.437691-05:00","closed_at":"2026-01-28T22:22:53.437691-05:00","close_reason":"lokt why \u003cname\u003e command fully implemented. Commit 0717828."}
{"id":"lokt-ao9","title":"Add lock_id to audit events","description":"Add a unique lock_id field to audit events so that acquire/release pairs can be reliably correlated. Options: UUID per acquisition, or a composite {host,pid,seq} tuple. This makes audit log post-processing much easier — tools can group events by lock lifecycle, measure hold durations, and detect anomalies. Add lock_id to the Event struct and populate it on acquire, renew, release, and break events. Ref: external technical review — audit log improvements.","status":"open","priority":3,"issue_type":"feature","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:01:14.930569-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:01:14.930569-05:00"}
{"id":"lokt-b06","title":"Release locks by owner (unlock --owner / --all)","description":"Add ability to release all locks held by a given owner. Two forms: lokt unlock --owner session:AAA (release all locks by that owner) and LOKT_OWNER=session:AAA lokt unlock --all (release all locks by current owner). Enables single-command session cleanup without needing to enumerate lock names.","status":"open","priority":2,"issue_type":"feature","owner":"nikolasavic@gmail.com","created_at":"2026-01-30T19:19:19.179948-05:00","created_by":"Nikola Savic","updated_at":"2026-01-30T19:19:19.179948-05:00"}
{"id":"lokt-b0a","title":"L-130 ttl-stale-handling","description":"## Summary\nImplement safe handling of stale/expired locks through TTL enforcement and PID liveness detection.\n\n## Acceptance Criteria\n- [ ] `unlock --break-stale` removes expired locks\n- [ ] `unlock --break-stale` refuses to break non-expired locks (exit code 1)\n- [ ] `unlock --break-stale` removes locks where PID is dead (same host only)\n- [ ] `status` shows PID liveness (alive/dead/unknown) on same host\n- [ ] `status --prune-expired` removes expired locks and reports them\n- [ ] `--ttl 0` or negative durations produce clear error\n- [ ] All new functionality has unit tests\n\n## Plan\n\n### Strategy\nBuild on existing TTL infrastructure (`Lock.IsExpired()`, `--ttl` flags) by adding:\n1. PID liveness detection in a new `internal/stale` package\n2. `--break-stale` option to Release()\n3. Status enhancement for liveness display\n4. Duration validation in command parsing\n\n### Patterns\n- Mirror: `internal/lock/release.go` for ownership check pattern\n- Mirror: `cmd/lokt/main.go:117` for flag handling pattern\n\n### Key Decisions\n- PID check only on same host (cross-host = unknown)\n- EPERM from kill(0) means process is alive (can't signal, but exists)\n- Windows: skip PID check, rely on TTL only\n\n## Edge Cases\n- Cross-host locks: Cannot verify PID - treat as unknown\n- PID reuse: Rare but TTL provides backup protection\n- Race conditions: Lock disappears between read/remove - handle gracefully\n- Permission errors: Cannot signal PID - treat as alive (safe default)\n\n## Constraints\n- No external dependencies for PID liveness\n- Must work on macOS and Linux\n- Windows fallback behavior\n- Backward compatible with existing lock files","notes":"source: _notes/story-drafts/l-130-ttl-stale-handling.md\nverify-level: agent\nverify-envs: local","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:21:45.300561-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:24:18.028172-05:00","closed_at":"2026-01-27T09:24:18.028172-05:00","close_reason":"## Summary\nL-130 TTL \u0026 Stale Lock Handling complete.\n\n## Implemented\n- internal/stale package with PID liveness detection (Unix/Windows)\n- --break-stale flag for unlock (removes expired or dead-PID locks)\n- Status shows PID liveness (alive/dead/unknown)\n- --prune-expired flag for status (auto-cleanup expired locks)\n- TTL validation (rejects negative values)\n\n## Commits\n- 6a1a112 feat(stale): add stale lock detection package\n- dd995d0 feat(cli): add --break-stale flag to unlock command\n- ff2032b feat(cli): add liveness display, prune-expired, TTL validation\n\n## Verification\nAll 23 unit tests pass. CLI functionality verified.","labels":["L-130","story"]}
{"id":"lokt-b0a.1","title":"L-130 internal: add stale detection package","description":"## What\nCreate `internal/stale` package with PID liveness detection.\n\n## Why\nCentralizes stale lock detection logic for use by both unlock and status commands.\n\n## Pattern\nMirror: `internal/identity/identity.go` for simple utility package pattern.\n\n## Implementation\n1. Create `internal/stale/stale.go`\n2. Add `IsProcessAlive(pid int) bool` - uses `syscall.Kill(pid, 0)`\n3. Add `IsStale(lock *lockfile.Lock) (stale bool, reason string)` - checks TTL expiry OR dead PID (same host)\n4. Add build tags for Unix vs Windows\n\n## Acceptance\n- [ ] `IsProcessAlive()` returns true for current PID\n- [ ] `IsProcessAlive()` returns false for non-existent PID\n- [ ] `IsStale()` returns true for expired TTL\n- [ ] `IsStale()` returns true for dead PID on same host\n- [ ] `IsStale()` returns false for different host (cannot verify)\n- [ ] Has unit tests","notes":"env: local\nverify: agent\nmaps-to-ac: R2 PID liveness check","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:19.932847-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:25:54.412672-05:00","closed_at":"2026-01-27T08:25:54.412672-05:00","close_reason":"## Evidence\n- Created internal/stale package with PID liveness detection\n- IsProcessAlive() uses syscall.Kill(pid, 0) on Unix\n- Windows fallback returns true (conservative)\n- Check() returns stale for expired TTL or dead PID (same host)\n- All 7 unit tests pass","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.1","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:19.935997-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.2","title":"L-130 lock: add break-stale to Release","description":"## What\nAdd `BreakStale` option to `lock.Release()` that removes expired/stale locks only.\n\n## Why\nProvides a safe middle ground between `--force` (break-glass) and normal unlock (owner-only).\n\n## Pattern\nMirror: `internal/lock/release.go:36` - extend `ReleaseOptions` struct.\n\n## Implementation\n1. Add `BreakStale bool` to `ReleaseOptions`\n2. In `Release()`, if BreakStale:\n   - Check `stale.IsStale(existing)`\n   - If stale, remove lock (skip ownership check)\n   - If not stale, return new `ErrNotStale` error\n3. Add `ErrNotStale` error type with details\n\n## Acceptance\n- [ ] `Release(opts{BreakStale: true})` removes expired locks\n- [ ] `Release(opts{BreakStale: true})` removes dead-PID locks (same host)\n- [ ] `Release(opts{BreakStale: true})` returns `ErrNotStale` for non-stale locks\n- [ ] Existing `Force` behavior unchanged\n- [ ] Has unit tests","notes":"env: local\nverify: agent\nmaps-to-ac: R1 break-stale flag","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:23.694258-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:27:20.617404-05:00","closed_at":"2026-01-27T08:27:20.617404-05:00","close_reason":"## Evidence\n- Added BreakStale option to ReleaseOptions\n- Added ErrNotStale error and NotStaleError type\n- Release() checks stale.Check() when BreakStale is true\n- Returns NotStaleError if lock is not stale\n- All 8 release tests pass including 4 new break-stale tests","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.2","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:23.696431-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-b0a.2","depends_on_id":"lokt-b0a.1","type":"blocks","created_at":"2026-01-27T08:22:43.286003-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.3","title":"L-130 cli: add --break-stale to unlock command","description":"## What\nAdd `--break-stale` flag to `lokt unlock` CLI command.\n\n## Why\nExposes the safe stale-lock removal to users.\n\n## Pattern\nMirror: `cmd/lokt/main.go:119` - existing `--force` flag pattern.\n\n## Implementation\n1. Add `breakStale` flag to `cmdUnlock()`\n2. Pass to `lock.Release()` as `BreakStale` option\n3. Handle `ErrNotStale` with appropriate exit code and message\n4. Update usage text\n\n## Acceptance\n- [ ] `lokt unlock --break-stale \u003cname\u003e` removes expired locks\n- [ ] `lokt unlock --break-stale \u003cname\u003e` returns exit 1 for non-stale locks\n- [ ] Error message explains why lock is not stale\n- [ ] Usage text updated","notes":"env: local\nverify: agent\nmaps-to-ac: R1 break-stale flag","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:26.823089-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:29:11.041207-05:00","closed_at":"2026-01-27T08:29:11.041207-05:00","close_reason":"## Evidence\n- Added --break-stale flag to cmdUnlock()\n- Passes BreakStale option to lock.Release()\n- Handles NotStaleError with clear error message\n- Updated usage text with flag descriptions\n- Build and all tests pass","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.3","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:26.825407-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-b0a.3","depends_on_id":"lokt-b0a.2","type":"blocks","created_at":"2026-01-27T08:22:46.007736-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.4","title":"L-130 cli: enhance status with liveness display","description":"## What\nShow PID liveness status in `lokt status` output.\n\n## Why\nHelps users identify stale locks before deciding to break them.\n\n## Pattern\nMirror: `cmd/lokt/main.go:296` - existing `showLock()` function.\n\n## Implementation\n1. In `showLock()` and `showLockBrief()`, check PID liveness\n2. Display status: `alive`, `dead`, or `unknown` (cross-host)\n3. Format: `pid: 1234 (alive)` or `pid: 1234 (dead)`\n4. In brief format: add indicator like `[DEAD]`\n\n## Acceptance\n- [ ] `lokt status \u003cname\u003e` shows PID liveness status\n- [ ] `lokt status` (list) shows liveness indicator\n- [ ] Cross-host locks show `unknown`\n- [ ] JSON output includes liveness field","notes":"env: local\nverify: agent\nmaps-to-ac: R2 PID liveness check","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:29.559726-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T08:36:41.929526-05:00","closed_at":"2026-01-27T08:36:41.929526-05:00","close_reason":"## Evidence\n- Added pidLiveness() helper using stale.IsProcessAlive()\n- showLock() displays: pid: 1234 (alive|dead|unknown)\n- showLockBrief() adds [DEAD] marker for dead PIDs\n- Cross-host locks show 'unknown' (cannot verify)\n- All tests pass","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.4","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:29.561581-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-b0a.4","depends_on_id":"lokt-b0a.1","type":"blocks","created_at":"2026-01-27T08:22:49.008389-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.5","title":"L-130 cli: add --prune-expired to status","description":"## What\nAdd `--prune-expired` flag to `lokt status` that removes expired locks.\n\n## Why\nProvides convenient cleanup of expired locks during status check.\n\n## Pattern\nMirror: `cmd/lokt/main.go:153` - existing `cmdStatus()` function.\n\n## Implementation\n1. Add `pruneExpired` flag to `cmdStatus()`\n2. When listing locks, check expiry\n3. If expired and prune enabled, remove lock\n4. Report pruned locks in output\n\n## Acceptance\n- [ ] `lokt status --prune-expired` removes expired locks\n- [ ] Output shows which locks were pruned\n- [ ] Non-expired locks are not affected\n- [ ] Works with specific lock name: `lokt status --prune-expired \u003cname\u003e`","notes":"env: local\nverify: agent\nmaps-to-ac: R3 auto-prune expired","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:32.40278-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:00:17.473691-05:00","closed_at":"2026-01-27T09:00:17.473691-05:00","close_reason":"## Evidence\n- Added --prune-expired flag to cmdStatus()\n- When listing, expired locks are removed and reported\n- When viewing specific lock with prune, removes if expired\n- Output shows 'pruned: {name} (expired)' and summary count\n- All tests pass\n- CLI tested manually with expired locks","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.5","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:32.40532-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b0a.6","title":"L-130 cli: validate TTL duration","description":"## What\nValidate that TTL durations are positive values.\n\n## Why\nPrevents confusing behavior from zero or negative TTL.\n\n## Pattern\nMirror: `cmd/lokt/main.go:87` - existing TTL flag parsing.\n\n## Implementation\n1. After parsing `--ttl` flag, validate \u003e 0\n2. If zero or negative, print error and return ExitUsage\n3. Apply to both `lock` and `guard` commands\n\n## Acceptance\n- [ ] `lokt lock --ttl 0 foo` produces error\n- [ ] `lokt lock --ttl -5m foo` produces error\n- [ ] Error message is clear about valid values\n- [ ] `lokt guard --ttl 0 foo -- cmd` same behavior","notes":"env: local\nverify: agent\nmaps-to-ac: R4 duration validation","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:35.267113-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:03:22.438576-05:00","closed_at":"2026-01-27T09:03:22.438576-05:00","close_reason":"## Evidence\n- Added TTL validation to cmdLock() and cmdGuard()\n- Negative TTL rejected with 'TTL must be positive' error\n- Exit code 64 (ExitUsage) for invalid TTL\n- Zero TTL allowed (means no TTL - lock never expires)\n- Positive TTL works as expected\n- All tests pass","labels":["L-130","task"],"dependencies":[{"issue_id":"lokt-b0a.6","depends_on_id":"lokt-b0a","type":"parent-child","created_at":"2026-01-27T08:22:35.268922-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-b1u","title":"guard --wait flag","description":"Add --wait and --timeout flags to guard command for parity with lock command.","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T16:06:04.937933-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T16:08:30.078338-05:00","closed_at":"2026-01-27T16:08:30.078338-05:00","close_reason":"Added --wait and --timeout to guard. Commit: 83304b6"}
{"id":"lokt-b81","title":"Scale concurrency hammer test to 100 goroutines","description":"Increase TestAcquireRace from 10 to 100 concurrent goroutines to stress-test lock acquisition under heavy contention. Also add a variant where goroutines use wait/poll with a short timeout, verifying exactly one winner per cycle across multiple acquire/release rounds. This catches file-descriptor leaks, retry logic bugs, and race conditions that only manifest at higher concurrency. Ref: external technical review — test plan item 1.","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:01:11.155664-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:01:11.155664-05:00"}
{"id":"lokt-bdn","title":"ARCHIVE: Terminal Mosaic demo (cancelled)","description":"## Archive: Terminal Mosaic Demo (Cancelled)\n\n**Decision:** Feature cancelled — the fancy mosaic TUI demo approach won't work.\n\n---\n\n### What it was\n\n`lokt demo mosaic` — a visually impressive terminal demo proving Lokt correctness under extreme concurrency. Workers raced to fill a colored tile grid through Lokt locks, with a live ANSI TUI showing progress, lock contention stats, freeze/crash recovery events.\n\n### Implementation status at cancellation\n\n**Code written (in repo):**\n- `internal/demo/` package: color.go, color_test.go, ledger.go, renderer.go, state.go, term_unix.go, verify.go, verify_test.go, worker.go\n- CLI wiring in cmd/lokt for `demo mosaic` subcommand\n\n**Commits (Jan 28, 2026):**\n- `e44d6a8` feat(cli): add lokt demo mosaic command\n- `b2bdbe9` fix(demo): resolve lint warnings in demo package\n\n**Beads (all closed):**\n- `lokt-7op` (epic): DEMO: Terminal Mosaic demo command — 5 subtasks all completed\n  - lokt-7op.1: core (ledger, tile color, hash chain, verifier)\n  - lokt-7op.2: workers (goroutine pool with single-phase locking)\n  - lokt-7op.3: renderer (ANSI truecolor TUI with sidebar stats)\n  - lokt-7op.4: CLI (command entry point, flags, orchestration)\n  - lokt-7op.5: nolock mode + chaos scenarios\n- `lokt-65w` (epic): DEMO verify:local — 5 subtasks, all cancelled\n  - lokt-65w.1 through lokt-65w.5: verification tasks (never executed)\n\n### Story draft\n\nFull design document at: `_notes/story-drafts/demo.md`\n\n### Key design decisions made\n\n- Single-phase protocol: claim+commit under one lock for strict sequential fill\n- Goroutines not subprocesses for v1\n- No external TUI library: raw ANSI sequences for zero deps\n- Ledger-driven renderer (reads from ledger file, not from worker channels)\n- SHA256 hash chain for integrity verification\n- Append-only JSONL ledger format\n\n### Features implemented\n\n- Deterministic tile colors from seed via splitmix64\n- Hash chain with GENESIS anchor\n- End-of-run verifier (count, contiguity, chain, uniqueness)\n- Keyboard shortcuts: f=freeze, u=unfreeze, k=kill holder, q=quit\n- `--mode nolock` contrast mode\n- Configurable: grid size, workers, TTL, FPS, tile-delay, seed\n- Live ANSI truecolor renderer with sidebar stats\n\n### Artifacts in repo (to be removed)\n\n- `internal/demo/` — all Go source files\n- `_notes/story-drafts/demo.md` — story draft\n- `.git/lokt/demo/mosaic/` — runtime artifacts (ledger, lock files)","status":"closed","priority":4,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T20:24:06.732705-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T20:24:41.57006-05:00","closed_at":"2026-01-29T20:24:41.57006-05:00","close_reason":"Archive-only bead. Mosaic demo cancelled. All context preserved in description."}
{"id":"lokt-bgr","title":"Add PID start time to stale detection","description":"Add process start time to the lock file schema and use it during stale detection to prevent PID-reuse false positives. Currently, stale detection checks if a PID is alive via kill(pid, 0), but if the PID has been recycled by the OS, a new unrelated process could be mistaken for the lock holder. Implementation: on Linux, read /proc/\u003cpid\u003e/stat field 22 (starttime in jiffies). On macOS, use sysctl or proc_pidinfo. Store start_time in lock JSON. During stale check, compare stored start_time with current process start_time for that PID. Ref: external technical review — break-stale safety.","status":"closed","priority":2,"issue_type":"feature","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:01:13.009191-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:42:59.039803-05:00","closed_at":"2026-01-28T22:42:59.039803-05:00","close_reason":"Closed"}
{"id":"lokt-bm6","title":"Write expires_at field and document monotonic time limits","description":"Write an explicit expires_at timestamp in the lock file alongside acquired_ts and ttl_sec. This removes the need for readers to do arithmetic and makes expiry checking more straightforward. Also document the inherent limitation: on-disk TTL comparison uses wall-clock time and is susceptible to NTP jumps or clock skew. In-process Go time.Since() with time.Now() values is monotonic-safe, but cross-process stale detection cannot be. Add a note in CLAUDE.md and/or README about this trade-off. Ref: external technical review — monotonic time.","status":"open","priority":3,"issue_type":"feature","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:01:22.791739-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:01:22.791739-05:00"}
{"id":"lokt-bzz","title":"Move freeze files to separate freezes/ namespace","description":"Move freeze files from locks/freeze-\u003cname\u003e.json to a dedicated freezes/\u003cname\u003e.json directory. Currently freeze files share the locks/ directory with a 'freeze-' prefix, which could collide if someone names a lock 'freeze-deploy'. A separate namespace is cleaner, avoids edge cases, and makes it easier to enumerate freezes independently of locks. Update: freeze, unfreeze, CheckFreeze, status listing, and doctor checks. Ensure backward compatibility by checking both locations during a transition period. Ref: external technical review.","status":"open","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:01:19.033329-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:01:19.033329-05:00"}
{"id":"lokt-cr6","title":"lokt-al5 verify:sandbox held lock","description":"## Check\nlokt why reports correct diagnosis when lock is held by another process.\n\n## Commands\nlokt lock test-verify --ttl 5m   # acquire in background\nlokt why test-verify             # should show held info\nlokt unlock test-verify          # cleanup\n\n## Expected\n- Output shows holder identity, age, PID status\n- Suggests --wait, --force, or --break-stale as appropriate\n- Exit code 2","notes":"env: sandbox\nverify: agent\nmaps-to-ac: held-by-other","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:12:41.455145-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:22:44.451685-05:00","closed_at":"2026-01-28T22:22:44.451685-05:00","close_reason":"Verified: lokt why held-lock → BLOCKED with holder info + suggestions, exit 2","dependencies":[{"issue_id":"lokt-cr6","depends_on_id":"lokt-pne","type":"blocks","created_at":"2026-01-28T22:12:53.851479-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-cy3","title":"L-171 emit-audit-events","description":"## Summary\nInstrument lock.Acquire() and lock.Release() to emit audit events using the audit.Writer from L-170. Events provide forensic trail for lock operations.\n\n## Acceptance Criteria\n- [ ] Acquire success: Emits acquire event with lock details\n- [ ] Acquire denied: Emits deny event with holder info in extra\n- [ ] Release normal: Emits release event\n- [ ] Release force: Emits force-break event\n- [ ] Release stale: Emits stale-break event\n- [ ] Non-blocking: Audit failures don't affect lock operation success/failure\n- [ ] Tests updated: Verify events are emitted in expected scenarios\n\n## Plan\n\n### Strategy\nAdd Auditor field to AcquireOptions and ReleaseOptions. Emit events at lock state change points. Keep audit optional (nil auditor = no emit).\n\n### Patterns\n- Mirror: existing Options struct pattern in lock package\n- Reuse: identity.Current() for event fields, audit.Writer.Emit()\n\n### Key Decisions\n- Options-based auditor: Avoids global state, keeps audit optional\n- Emit after state change: Only emit when lock file actually changes\n- Holder info in extra: deny events include who holds the lock\n\n## Edge Cases\n- Audit writer is nil — skip emit, don't panic\n- Lock validation fails — no event (not a state change)\n- AcquireWithWait retries — only emit on final success\n\n## Constraints\n- Don't break existing function signatures\n- Include full identity info in events","notes":"source: _notes/story-drafts/l-171-emit-audit-events.md\nverify-level: optional\nverify-envs: local","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:29:54.756414-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:37:29.922274-05:00","closed_at":"2026-01-27T18:37:29.922274-05:00","close_reason":"L-171 complete. lock.Acquire and lock.Release emit audit events via optional Auditor field in options.","labels":["L-171","story"]}
{"id":"lokt-cy3.1","title":"L-171 lock: add Auditor to options and emit acquire/deny events","description":"## What\nAdd Auditor field to AcquireOptions. Emit acquire event on success, deny event on HeldError.\n\n## Why\nCore audit instrumentation for lock acquisition - the most common operation.\n\n## Pattern\nMirror: existing Options struct pattern\n\n## Acceptance\n- [ ] AcquireOptions gains Auditor *audit.Writer field\n- [ ] Acquire() emits acquire event after successful lock write\n- [ ] Acquire() emits deny event when returning HeldError (include holder in extra)\n- [ ] Nil auditor is handled gracefully (no emit, no panic)\n- [ ] Events include: name, owner, host, pid, ttl_sec","notes":"env: local\nverify: agent\nmaps-to-ac: acquire-success, acquire-denied, non-blocking","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:30:07.184931-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:33:49.136195-05:00","closed_at":"2026-01-27T18:33:49.136195-05:00","close_reason":"Added Auditor to AcquireOptions. Emit acquire/deny events with holder info in extra. Build and tests pass.","labels":["L-171","task"],"dependencies":[{"issue_id":"lokt-cy3.1","depends_on_id":"lokt-cy3","type":"parent-child","created_at":"2026-01-27T18:30:07.18755-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-cy3.2","title":"L-171 lock: emit release/force-break/stale-break events","description":"## What\nAdd Auditor field to ReleaseOptions. Emit appropriate event type based on release mode.\n\n## Why\nComplete audit coverage for lock lifecycle - releases are as important as acquires.\n\n## Pattern\nMirror: AcquireOptions auditor pattern from task 1\n\n## Acceptance\n- [ ] ReleaseOptions gains Auditor *audit.Writer field\n- [ ] Release() emits release event for normal release\n- [ ] Release() emits force-break event when opts.Force=true\n- [ ] Release() emits stale-break event when opts.BreakStale=true\n- [ ] Events include lock info (name, owner, host, pid)","notes":"env: local\nverify: agent\nmaps-to-ac: release-normal, release-force, release-stale","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:30:18.520686-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:35:03.624051-05:00","closed_at":"2026-01-27T18:35:03.624051-05:00","close_reason":"Added Auditor to ReleaseOptions. Emit release/force-break/stale-break events based on options. Build and tests pass.","labels":["L-171","task"],"dependencies":[{"issue_id":"lokt-cy3.2","depends_on_id":"lokt-cy3","type":"parent-child","created_at":"2026-01-27T18:30:18.523975-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-cy3.2","depends_on_id":"lokt-cy3.1","type":"blocks","created_at":"2026-01-27T18:30:38.974024-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-cy3.3","title":"L-171 lock: add audit event tests","description":"## What\nAdd tests verifying audit events are emitted correctly for all scenarios.\n\n## Why\nEnsure audit instrumentation works and doesn't regress.\n\n## Pattern\nMirror: existing lock package tests, use temp dir for audit file\n\n## Acceptance\n- [ ] Test acquire emits acquire event\n- [ ] Test acquire denied emits deny event with holder info\n- [ ] Test release emits release event\n- [ ] Test force release emits force-break event\n- [ ] Test stale break emits stale-break event\n- [ ] Test nil auditor doesn't panic","notes":"env: local\nverify: agent\nmaps-to-ac: tests-updated","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:30:29.533289-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:37:18.506834-05:00","closed_at":"2026-01-27T18:37:18.506834-05:00","close_reason":"Added 7 audit event tests: acquire, deny with holder info, release, force-break, stale-break, nil auditor safety. All tests pass.","labels":["L-171","task"],"dependencies":[{"issue_id":"lokt-cy3.3","depends_on_id":"lokt-cy3","type":"parent-child","created_at":"2026-01-27T18:30:29.536093-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-cy3.3","depends_on_id":"lokt-cy3.2","type":"blocks","created_at":"2026-01-27T18:30:39.206662-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-ddd","title":"L-170 audit-schema","description":"## Summary\nDefine audit event schema and create internal/audit package with Writer for append-only JSONL logging. This is the foundation for lock operation observability.\n\n## Acceptance Criteria\n- [ ] Schema defined: Event struct with ts, event, name, owner, host, pid, ttl_sec, extra fields\n- [ ] Event types: Constants for acquire, deny, release, force-break, stale-break\n- [ ] Writer created: audit.Writer with Emit(event) method\n- [ ] Atomic append: Uses O_APPEND + fsync for concurrent safety\n- [ ] Non-blocking: Writer.Emit never returns error to caller; logs failures to stderr\n- [ ] Unit tests: Cover schema serialization and file append behavior\n\n## Plan\n\n### Strategy\nCreate a minimal internal/audit package following the lockfile package pattern. Event struct + Writer with non-blocking Emit().\n\n### Patterns\n- Mirror: `internal/lockfile/lockfile.go` — same JSON struct + file I/O approach\n- Reuse: `root.EnsureDirs()` for directory creation\n\n### Key Decisions\n- Non-blocking writes: Emit() logs errors to stderr, never fails caller\n- O_APPEND for atomicity: POSIX guarantees atomic append for small writes\n- No rotation: Out of scope for L-170\n\n## Edge Cases\n- Audit file doesn't exist — create on first write\n- Audit directory doesn't exist — use root.EnsureDirs pattern\n- Concurrent writers — O_APPEND is atomic on POSIX for small writes\n- Disk full — log warning to stderr, don't block lock operations\n\n## Constraints\n- JSON field names: ts, event, name, owner, host, pid, ttl_sec, extra\n- RFC3339 timestamps (consistent with lockfile)","notes":"source: _notes/story-drafts/l-170-audit-log.md\nverify-level: optional\nverify-envs: local","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:18:25.584496-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:24:33.890327-05:00","closed_at":"2026-01-27T18:24:33.890327-05:00","close_reason":"L-170 complete. internal/audit package with Event schema, Writer, and unit tests.","labels":["L-170","story"]}
{"id":"lokt-ddd.1","title":"L-170 audit: define Event schema and constants","description":"## What\nCreate internal/audit/audit.go with Event struct and event type constants.\n\n## Why\nFoundation for all audit logging - defines the JSONL schema.\n\n## Pattern\nMirror: `internal/lockfile/lockfile.go` — same struct + JSON tags approach\n\n## Acceptance\n- [ ] Event struct with fields: ts (time.Time), event (string), name, owner, host, pid, ttl_sec, extra (map[string]any)\n- [ ] Constants: EventAcquire, EventDeny, EventRelease, EventForceBreak, EventStaleBreak\n- [ ] JSON tags match spec: ts, event, name, owner, host, pid, ttl_sec, extra\n- [ ] Event.MarshalJSON uses RFC3339 for timestamp","notes":"env: local\nverify: agent\nmaps-to-ac: schema-defined, event-types","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:18:34.501499-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:22:26.769081-05:00","closed_at":"2026-01-27T18:22:26.769081-05:00","close_reason":"Event struct and constants defined in internal/audit/audit.go. Build passes.","labels":["L-170","task"],"dependencies":[{"issue_id":"lokt-ddd.1","depends_on_id":"lokt-ddd","type":"parent-child","created_at":"2026-01-27T18:18:34.503842-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-ddd.2","title":"L-170 audit: implement Writer with non-blocking Emit","description":"## What\nCreate audit.Writer struct with Emit(Event) method that appends to audit.log.\n\n## Why\nCore write infrastructure - must be non-blocking so lock ops never fail due to audit.\n\n## Pattern\nMirror: `internal/lockfile/lockfile.go` Write() — but simpler (append-only, no temp file)\n\n## Acceptance\n- [ ] Writer struct holds root directory path\n- [ ] NewWriter(rootDir string) constructor\n- [ ] Emit(Event) appends JSON line to \u003croot\u003e/audit.log\n- [ ] Uses O_APPEND|O_CREATE|O_WRONLY with fsync\n- [ ] Emit never returns error - logs to stderr on failure\n- [ ] Creates audit.log on first write if missing","notes":"env: local\nverify: agent\nmaps-to-ac: writer-created, atomic-append, non-blocking","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:18:44.984119-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:23:09.183446-05:00","closed_at":"2026-01-27T18:23:09.183446-05:00","close_reason":"Writer struct with non-blocking Emit() implemented. Uses O_APPEND+fsync. Build passes.","labels":["L-170","task"],"dependencies":[{"issue_id":"lokt-ddd.2","depends_on_id":"lokt-ddd","type":"parent-child","created_at":"2026-01-27T18:18:44.985885-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-ddd.2","depends_on_id":"lokt-ddd.1","type":"blocks","created_at":"2026-01-27T18:18:58.56267-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-ddd.3","title":"L-170 audit: add unit tests","description":"## What\nCreate internal/audit/audit_test.go with tests for Event serialization and Writer behavior.\n\n## Why\nVerify schema correctness and append behavior before integrating with lock ops.\n\n## Pattern\nMirror: `internal/lockfile/lockfile_test.go` — table-driven tests\n\n## Acceptance\n- [ ] Test Event JSON serialization matches expected format\n- [ ] Test timestamp uses RFC3339\n- [ ] Test Writer creates file on first emit\n- [ ] Test Writer appends multiple events correctly (valid JSONL)\n- [ ] Test Writer handles missing directory gracefully","notes":"env: local\nverify: agent\nmaps-to-ac: unit-tests","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:18:52.725945-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:24:19.100738-05:00","closed_at":"2026-01-27T18:24:19.100738-05:00","close_reason":"Unit tests added and passing. All 7 tests cover serialization, file creation, append, timestamps, and edge cases.","labels":["L-170","task"],"dependencies":[{"issue_id":"lokt-ddd.3","depends_on_id":"lokt-ddd","type":"parent-child","created_at":"2026-01-27T18:18:52.729003-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-ddd.3","depends_on_id":"lokt-ddd.2","type":"blocks","created_at":"2026-01-27T18:18:58.72203-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-dxz","title":"L-200 heartbeat-lease-renewal","description":"## Summary\nGuard command automatically renews its lock's TTL at regular intervals while the child process runs. This prevents long-running commands from losing their lock protection mid-execution.\n\n## Acceptance Criteria\n- [ ] **Heartbeat interval**: Guard with `--ttl 5m` uses 2m30s heartbeat interval (TTL/2)\n- [ ] **Renewal updates timestamp**: Lock file's `acquired_ts` is updated to current time on each heartbeat\n- [ ] **Renewal is atomic**: Lock deletion during renewal fails gracefully without crash\n- [ ] **Stolen lock detection**: Owner mismatch on renewal logs warning\n- [ ] **Child exit stops heartbeat**: Heartbeat goroutine stops immediately when child exits\n- [ ] **Audit events**: Successful renewals emit `renew` event to audit log\n- [ ] **No overhead without TTL**: No heartbeat goroutine started when `--ttl` not specified\n\n## Plan\n\n### Strategy\nAdd a heartbeat goroutine to cmdGuard that periodically renews the lock's timestamp. The goroutine runs in parallel with the child process and is cancelled when the child exits or on signal.\n\n### Patterns\n- Mirror: `internal/lock/acquire.go` — atomic file operations, identity verification\n- Mirror: `cmd/lokt/main.go:cmdGuard` — signal handling, deferred cleanup\n- Mirror: `lockfile.Write()` — atomic write pattern (temp + rename + fsync)\n\n### Key Decisions\n- Renewal interval = TTL/2 (gives one retry before expiration)\n- Minimum interval of 500ms for very short TTLs\n- Renewal failure logs warning but doesn't terminate child\n- New `internal/lock/renew.go` file for renewal logic\n\n## Edge Cases\n- TTL \u003c 1s: use minimum 500ms interval\n- Renewal races with unlock at exit: context cancellation before ticker fires\n- Lock deleted externally: return error, log warning, continue\n- Signal during renewal: context cancelled, goroutine exits promptly\n\n## Constraints\n- Atomic file writes using existing lockfile.Write()\n- Owner/host/pid verification before overwriting\n- Proper goroutine cleanup on all exit paths\n- Must not block signal forwarding to child","notes":"source: _notes/story-drafts/l-200-heartbeat-lease-renewal.md\nverify-level: required\nverify-envs: sandbox","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T08:59:54.739177-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T15:53:07.852377-05:00","closed_at":"2026-01-28T15:53:07.852377-05:00","close_reason":"L-200 complete. Implementation verified: heartbeat goroutine renews TTL at TTL/2 intervals, emits renew audit events, detects stolen locks with warning, no overhead without TTL. All acceptance criteria met."}
{"id":"lokt-e01","title":"L-201 auto-prune-dead-locks","description":"## Summary\nAuto-prune stale locks (dead PID on same host) during immediate acquisition instead of returning HeldError. Self-healing behavior that reduces friction in CI/CD and multi-agent workflows.\n\n## Acceptance Criteria\n- [ ] `lokt lock \u003cname\u003e` succeeds when existing lock has dead PID on same host\n- [ ] `lokt guard \u003cname\u003e -- cmd` auto-prunes before acquiring\n- [ ] Cross-host locks are never auto-pruned (even if TTL expired)\n- [ ] TTL-expired locks on same host with live PID are NOT auto-pruned\n- [ ] Audit log contains `auto-prune` event with previous holder info\n- [ ] No user-visible output during auto-prune (silent)\n- [ ] Race condition: if another process acquires between prune and retry, return HeldError\n\n## Plan\n\n### Strategy\nIntegrate stale-check logic into the immediate `Acquire()` path. When lock file exists, check staleness before returning HeldError. If stale (dead PID + same host), remove and retry once.\n\n### Patterns\n- Mirror: `tryBreakStale()` in `acquire.go:169-188` — same stale detection logic\n- Mirror: `emitDenyEvent()` pattern for audit emission with holder info\n\n### Key Decisions\n- New audit event `auto-prune`: Distinguishes automatic cleanup from manual `--break-stale`\n- Single retry after prune: Keeps logic simple, handles race correctly\n- Same-host constraint: Cannot verify remote PIDs, so never auto-prune cross-host\n\n## Edge Cases\n1. Lock holder still alive: Must not prune\n2. Different host: Cannot verify PID, do not prune\n3. Race during prune: Process A prunes, B acquires, A gets HeldError — correct\n4. File removal fails: Log warning, return original HeldError\n\n## Constraints\n- No new CLI flags (automatic behavior)\n- No changes to exit codes or error messages for non-stale locks","notes":"source: _notes/story-drafts/l-201-auto-prune-dead-locks.md\nverify-level: agent\nverify-envs: local","status":"closed","priority":1,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:15:04.031473-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:21:54.070295-05:00","closed_at":"2026-01-28T09:21:54.070295-05:00","close_reason":"All tasks complete. Auto-prune feature implemented with tests.","labels":["L-201","hardening","story"]}
{"id":"lokt-e01.1","title":"L-201 audit: add EventAutoPrune constant","description":"## What\nAdd new audit event type `auto-prune` to distinguish automatic stale lock cleanup from manual `--break-stale`.\n\n## Why\nAudit log should clearly indicate when locks were auto-pruned vs manually broken. This aids debugging and forensics.\n\n## Pattern\nMirror existing event constants in `internal/audit/audit.go:13-19`\n\n## Acceptance\n- [ ] `EventAutoPrune = \"auto-prune\"` added to audit constants\n- [ ] Existing tests pass","notes":"env: local\nverify: agent\nmaps-to-ac: audit event type","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:15:24.069509-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:18:22.090241-05:00","closed_at":"2026-01-28T09:18:22.090241-05:00","close_reason":"Added EventAutoPrune constant. Tests pass.","labels":["L-201","task"],"dependencies":[{"issue_id":"lokt-e01.1","depends_on_id":"lokt-e01","type":"parent-child","created_at":"2026-01-28T09:15:24.078291-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-e01.2","title":"L-201 acquire: add auto-prune logic before HeldError","description":"## What\nModify `Acquire()` to check for stale locks before returning HeldError. If lock is stale (dead PID + same host), remove it, emit audit event, and retry acquisition once.\n\n## Why\nCore feature: self-healing behavior that cleans up orphaned locks automatically.\n\n## Pattern\nMirror `tryBreakStale()` logic at `acquire.go:169-188` but integrate into immediate Acquire path.\n\n## Implementation\nIn `Acquire()` around line 73-83, after reading existing lock:\n1. Call `stale.Check(existing)`\n2. If stale (dead PID reason only, not just TTL expired):\n   - Remove lock file\n   - Emit `EventAutoPrune` with holder info\n   - Retry atomic create once\n3. If not stale or retry fails, return HeldError as before\n\n## Acceptance\n- [ ] Dead PID locks on same host are auto-pruned\n- [ ] Cross-host locks are never auto-pruned\n- [ ] TTL-only expired locks with live PID are NOT auto-pruned\n- [ ] Audit event emitted with previous holder info\n- [ ] Race condition handled (retry can still fail)","notes":"env: local\nverify: agent\nmaps-to-ac: core feature","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:15:26.285537-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:20:10.387163-05:00","closed_at":"2026-01-28T09:20:10.387163-05:00","close_reason":"Added auto-prune logic to Acquire(). All existing tests pass.","labels":["L-201","task"],"dependencies":[{"issue_id":"lokt-e01.2","depends_on_id":"lokt-e01","type":"parent-child","created_at":"2026-01-28T09:15:26.290443-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-e01.2","depends_on_id":"lokt-e01.1","type":"blocks","created_at":"2026-01-28T09:15:36.097818-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-e01.3","title":"L-201 test: add auto-prune unit tests","description":"## What\nAdd comprehensive unit tests for the new auto-prune behavior in `acquire_test.go`.\n\n## Why\nVerify auto-prune works correctly and doesn't regress existing behavior.\n\n## Test Cases\n1. `TestAcquire_AutoPrunesDeadPIDLock` - Lock with dead PID on same host is auto-pruned\n2. `TestAcquire_NoAutoPruneCrossHost` - Lock from different host is NOT auto-pruned\n3. `TestAcquire_NoAutoPruneLivePID` - Lock with live PID is NOT auto-pruned\n4. `TestAcquire_AutoPruneEmitsAuditEvent` - Verify audit event with holder info\n5. `TestAcquire_AutoPruneRaceCondition` - Verify HeldError if another process wins race\n\n## Pattern\nMirror existing tests like `TestAcquireWithWait_BreaksDeadPIDLock` at `acquire_test.go:254-297`\n\n## Acceptance\n- [ ] All new tests pass\n- [ ] Existing tests still pass\n- [ ] Tests cover edge cases (cross-host, live PID, race)","notes":"env: local\nverify: agent\nmaps-to-ac: test coverage","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:15:28.85903-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:21:46.576002-05:00","closed_at":"2026-01-28T09:21:46.576002-05:00","close_reason":"Added 5 auto-prune tests. All pass.","labels":["L-201","task"],"dependencies":[{"issue_id":"lokt-e01.3","depends_on_id":"lokt-e01","type":"parent-child","created_at":"2026-01-28T09:15:28.869505-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-e01.3","depends_on_id":"lokt-e01.2","type":"blocks","created_at":"2026-01-28T09:15:36.292687-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-eie","title":"L-140 lock-wait","description":"## Summary\nAdd `--wait` flag to `lokt lock` command that polls until the lock is acquired. Foundation for wait/timeout/backoff features (L-141, L-142, L-143).\n\n## Acceptance Criteria\n- [ ] **Basic wait**: Given lock is held, when `lokt lock --wait foo` runs, then it polls until lock is released and acquires it\n- [ ] **Indefinite wait**: Given `--wait` with no timeout, waits indefinitely until signal\n- [ ] **Signal handling**: Given waiting, when SIGINT received, exits cleanly with non-zero code\n- [ ] **Exit code on success**: When acquired, exit code is 0\n- [ ] **TTL preserved**: `--wait` combined with `--ttl 5m` sets TTL correctly\n- [ ] **Stale lock handling**: If lock is stale (expired TTL or dead PID), auto-break and acquire\n\n## Plan\n\n### Strategy\nAdd `AcquireWithWait` function to `internal/lock` package that wraps `Acquire` in a context-aware polling loop. Use 100ms polling interval (hardcoded for L-140, configurable in L-142).\n\n### Patterns\n- Mirror: `cmdGuard` signal handling pattern in `main.go:321-324`\n- Mirror: `stale.Check()` for stale lock detection during wait\n\n### Key Decisions\n- Use context.Context for cancellation (enables clean signal handling)\n- Hardcode 100ms poll interval (L-142 will add backoff/jitter)\n- Auto-break stale locks during wait (better UX than waiting forever)\n\n## Edge Cases\n- Lock released between check and acquire (race) — retry loop handles this\n- Lock file deleted externally — acquire succeeds on next poll\n- Lock held by same owner — current re-entrant behavior preserved\n\n## Constraints\n- Polling interval hardcoded (100ms) — L-142 adds configurability\n- No progress output — L-143 adds this\n- Must not break existing non-wait behavior","notes":"source: _notes/story-drafts/l-140-lock-wait.md\nverify-level: optional\nverify-envs: sandbox","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T13:59:41.012757-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T14:08:57.7019-05:00","closed_at":"2026-01-27T14:08:57.7019-05:00","close_reason":"L-140 complete: Added --wait flag to lock command with context-based polling, stale lock auto-break, and signal handling."}
{"id":"lokt-eie.1","title":"L-140 lock: add AcquireWithWait function","description":"## What\nAdd `AcquireWithWait` function to `internal/lock/acquire.go` that polls until lock is acquired or context is cancelled.\n\n## Why\nEncapsulates polling logic in reusable function. Context-based cancellation enables clean signal handling. Prepares for L-141 timeout and L-142 backoff.\n\n## Pattern\nMirror: `stale.Check()` for detecting stale locks to auto-break\n\n## Implementation\n```go\nfunc AcquireWithWait(ctx context.Context, rootDir, name string, opts AcquireOptions) error {\n    // First attempt without wait\n    err := Acquire(rootDir, name, opts)\n    if err == nil {\n        return nil\n    }\n    var held *HeldError\n    if !errors.As(err, \u0026held) {\n        return err // non-held error, don't retry\n    }\n    \n    ticker := time.NewTicker(100 * time.Millisecond)\n    defer ticker.Stop()\n    \n    for {\n        select {\n        case \u003c-ctx.Done():\n            return ctx.Err()\n        case \u003c-ticker.C:\n            // Check if stale, auto-break if so\n            if tryBreakStale(rootDir, name) {\n                // Stale lock broken, try acquire\n            }\n            err := Acquire(rootDir, name, opts)\n            if err == nil {\n                return nil\n            }\n            if !errors.As(err, \u0026held) {\n                return err\n            }\n        }\n    }\n}\n```\n\n## Acceptance\n- [ ] Function signature: `AcquireWithWait(ctx context.Context, rootDir, name string, opts AcquireOptions) error`\n- [ ] Returns nil on successful acquire\n- [ ] Returns ctx.Err() on context cancellation\n- [ ] Auto-breaks stale locks (expired TTL or dead PID)\n- [ ] Uses 100ms polling interval","notes":"env: local\nverify: agent\nmaps-to-ac: basic-wait,stale-lock-handling","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T13:59:54.505014-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T14:03:13.612682-05:00","closed_at":"2026-01-27T14:03:13.612682-05:00","close_reason":"Implemented AcquireWithWait with context-based cancellation and stale lock auto-break. Commit: 805be86","dependencies":[{"issue_id":"lokt-eie.1","depends_on_id":"lokt-eie","type":"parent-child","created_at":"2026-01-27T13:59:54.507328-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-eie.2","title":"L-140 cli: add --wait flag to lock command","description":"## What\nAdd `--wait` boolean flag to `cmdLock` function that enables polling behavior.\n\n## Why\nUser-facing interface for the wait feature. Integrates with signal handling for clean cancellation.\n\n## Pattern\nMirror: signal handling in `cmdGuard` (main.go:321-324)\n\n## Implementation\n```go\nfunc cmdLock(args []string) int {\n    fs := flag.NewFlagSet(\"lock\", flag.ExitOnError)\n    ttl := fs.Duration(\"ttl\", 0, \"Lock TTL (e.g., 5m, 1h)\")\n    wait := fs.Bool(\"wait\", false, \"Wait for lock to be free\")\n    // ...\n    \n    if *wait {\n        ctx, cancel := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM)\n        defer cancel()\n        \n        err = lock.AcquireWithWait(ctx, rootDir, name, lock.AcquireOptions{TTL: *ttl})\n        if err != nil {\n            if errors.Is(err, context.Canceled) {\n                return ExitError  // Signal received\n            }\n            // handle HeldError (shouldn't happen with infinite wait)\n        }\n    } else {\n        err = lock.Acquire(rootDir, name, lock.AcquireOptions{TTL: *ttl})\n    }\n}\n```\n\n## Acceptance\n- [ ] `--wait` flag added to lock command\n- [ ] Flag documented in usage()\n- [ ] Signal handling (SIGINT/SIGTERM) cancels wait cleanly\n- [ ] Exit code 0 on success, non-zero on signal/error\n- [ ] TTL flag works with --wait","notes":"env: local\nverify: agent\nmaps-to-ac: signal-handling,ttl-preserved,exit-code-on-success","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T14:00:06.071877-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T14:04:54.88795-05:00","closed_at":"2026-01-27T14:04:54.88795-05:00","close_reason":"Added --wait flag with signal handling. Commit: a5c8cee","dependencies":[{"issue_id":"lokt-eie.2","depends_on_id":"lokt-eie","type":"parent-child","created_at":"2026-01-27T14:00:06.073875-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-eie.2","depends_on_id":"lokt-eie.1","type":"blocks","created_at":"2026-01-27T14:00:12.442671-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-eie.3","title":"L-140 test: add wait behavior tests","description":"## What\nAdd unit tests for `AcquireWithWait` function covering wait, cancellation, and stale lock scenarios.\n\n## Why\nVerify polling logic, context cancellation, and stale lock auto-break work correctly.\n\n## Pattern\nMirror: existing tests in `internal/lock/acquire_test.go`\n\n## Test Cases\n1. **Wait succeeds when lock released**: Start goroutine that releases lock after delay, verify AcquireWithWait succeeds\n2. **Context cancellation**: Cancel context during wait, verify returns ctx.Err()\n3. **Stale lock broken**: Create expired lock, verify AcquireWithWait auto-breaks and acquires\n4. **Dead PID broken**: Create lock with dead PID (same host), verify auto-break\n5. **Immediate success**: No contention, verify returns immediately without polling\n\n## Acceptance\n- [ ] Test wait succeeds after lock released\n- [ ] Test context cancellation during wait\n- [ ] Test stale lock (expired TTL) auto-break\n- [ ] Test dead PID lock auto-break\n- [ ] Tests pass: `go test ./internal/lock/...`","notes":"env: local\nverify: agent\nmaps-to-ac: basic-wait,signal-handling,stale-lock-handling","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T14:00:22.58201-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T14:06:15.199484-05:00","closed_at":"2026-01-27T14:06:15.199484-05:00","close_reason":"Added 6 unit tests for AcquireWithWait. Commit: 18fbfd3","dependencies":[{"issue_id":"lokt-eie.3","depends_on_id":"lokt-eie","type":"parent-child","created_at":"2026-01-27T14:00:22.584437-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-eie.3","depends_on_id":"lokt-eie.1","type":"blocks","created_at":"2026-01-27T14:00:27.975224-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-gba","title":"L-200 verify:sandbox heartbeat renews lock","description":"## Check\nVerify that guard with TTL renews the lock timestamp before expiration.\n\n## Command\n```bash\n# Start a guard with 4s TTL running a 10s sleep\n./lokt guard --ttl 4s test-heartbeat -- sleep 10 \u0026\nGUARD_PID=$\\!\n\n# Check initial timestamp\nsleep 1\nINITIAL_TS=$(./lokt status test-heartbeat --json | jq -r '.acquired_ts')\n\n# Wait past first renewal (2s interval for 4s TTL)\nsleep 3\n\n# Check timestamp was updated\nRENEWED_TS=$(./lokt status test-heartbeat --json | jq -r '.acquired_ts')\n\n# Verify different timestamps\n[ \"$INITIAL_TS\" \\!= \"$RENEWED_TS\" ] \u0026\u0026 echo 'PASS: Timestamp renewed' || echo 'FAIL: Timestamp unchanged'\n\n# Cleanup\nkill $GUARD_PID 2\u003e/dev/null || true\n```\n\n## Expected\n- Lock timestamp should be different after renewal\n- Lock should NOT expire during the 10s sleep","notes":"env: sandbox\nverify: agent\nmaps-to-ac: heartbeat-interval, renewal-updates-timestamp","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:01:06.85146-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T15:52:44.305439-05:00","closed_at":"2026-01-28T15:52:44.305439-05:00","close_reason":"Verified: guard with --ttl 4s renews timestamp (2026-01-28T15:51:00 -\u003e 2026-01-28T15:51:04). Lock did not expire during 12s sleep with 4s TTL."}
{"id":"lokt-gn7","title":"L-200 verify:sandbox stolen lock warning","description":"## Check\nVerify that renewal detects stolen lock and logs warning.\n\n## Command\n```bash\n# Start guard with TTL\n./lokt guard --ttl 2s test-stolen -- sleep 10 \u0026\nGUARD_PID=$!\nsleep 0.5\n\n# Force-break the lock and re-acquire as different owner\nLOKT_OWNER=thief ./lokt unlock --force test-stolen\nLOKT_OWNER=thief ./lokt lock test-stolen\n\n# Wait for renewal attempt (should fail with warning)\nsleep 2\n\n# Check stderr output (redirect guard stderr to file for inspection)\n# The guard should have logged a warning about lock stolen\n\n# Cleanup\nkill $GUARD_PID 2\u003e/dev/null || true\nLOKT_OWNER=thief ./lokt unlock --force test-stolen 2\u003e/dev/null || true\n```\n\n## Expected\n- Guard should log warning about lock renewal failure (stolen)\n- Guard should continue running (not crash)\n- Child process should complete if not killed","notes":"env: sandbox\nverify: agent\nmaps-to-ac: stolen-lock-detection","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:01:15.207338-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T15:52:54.462262-05:00","closed_at":"2026-01-28T15:52:54.462262-05:00","close_reason":"Verified: after force-break + re-acquire by thief, guard stderr showed 'warning: lock renewal failed: lock stolen: now owned by thief@Phoebe.local'. Guard continued running without crash."}
{"id":"lokt-h6m","title":"lokt-al5 test: unit tests for why command","description":"## What\nWrite tests covering all denial scenarios for the why command logic.\n\n## Why\nEach scenario has distinct output and exit codes. Tests ensure correctness across the matrix.\n\n## Pattern\nMirror: existing test patterns in cmd/lokt/ or internal/ packages.\n\n## Test Matrix\n- [ ] No lock exists → free, exit 0\n- [ ] Lock held by other (same host, PID alive) → blocked, exit 2\n- [ ] Lock held by other (cross-host) → blocked, exit 2, notes PID unverifiable\n- [ ] Lock frozen → blocked, exit 2, shows freeze info\n- [ ] Lock frozen + held → blocked, exit 2, reports both\n- [ ] Lock expired → blocked, exit 2, suggests break-stale\n- [ ] Lock held by dead PID (same host) → blocked, exit 2, suggests break-stale\n- [ ] Corrupted lock file → blocked, exit 2, suggests force\n- [ ] Self-held (same owner+host+PID) → special message\n- [ ] Invalid name → exit 64\n- [ ] --json produces valid JSON for each scenario\n\n## Acceptance\n- [ ] All scenarios covered with assertions on exit code + output content\n- [ ] Tests pass: go test ./...","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:12:12.701175-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:21:53.379265-05:00","closed_at":"2026-01-28T22:21:53.379265-05:00","close_reason":"20 tests covering all scenarios: free, held (same host alive, cross-host), frozen, frozen+held, expired, dead PID, corrupted, self-held, invalid name, no args, expired freeze, plus JSON variants. All pass.","dependencies":[{"issue_id":"lokt-h6m","depends_on_id":"lokt-pne","type":"blocks","created_at":"2026-01-28T22:12:20.352832-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-h9g","title":"L-186/187 verify:sandbox","description":"Verification for L-186/187 GitHub Release Pipeline\n\nLinked story: lokt-uyq\n\n## Scope\n- Agent-verifiable: goreleaser dry-run, workflow syntax validation\n- Human-verifiable: Actual tag push and release creation (requires pre-release tag)\n\n## Environments\nsandbox (test with pre-release tag like v0.0.1-test)","notes":"linked-story: lokt-uyq\nverify-level: required","status":"closed","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:36:57.089062-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:37:10.113052-05:00","closed_at":"2026-01-27T13:37:10.113052-05:00","close_reason":"All verification tasks passed.","labels":["L-186","L-187","verification"]}
{"id":"lokt-h9g.1","title":"L-186 verify:local goreleaser dry-run","description":"## Check\nVerify goreleaser config is valid and produces expected artifacts.\n\n## Command\n```bash\ngoreleaser check\ngoreleaser build --snapshot --clean\nls dist/\n```\n\n## Expected\n- goreleaser check passes\n- Build produces binaries for all 4 platforms (darwin/linux × amd64/arm64)\n- Binaries show correct version when run","notes":"env: local\nverify: agent\nmaps-to-ac: Binaries work","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:37:15.110329-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:32:08.230689-05:00","closed_at":"2026-01-27T13:32:08.230689-05:00","close_reason":"goreleaser check passes. Snapshot build produces 4 binaries (darwin/linux × amd64/arm64). Version output shows correct version/commit/date.","labels":["L-186","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-h9g.1","depends_on_id":"lokt-h9g","type":"parent-child","created_at":"2026-01-27T11:37:15.112039-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-h9g.1","depends_on_id":"lokt-uyq.2","type":"blocks","created_at":"2026-01-27T11:37:28.408053-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-h9g.2","title":"L-186 verify:local workflow syntax","description":"## Check\nVerify GitHub Actions workflow YAML is valid.\n\n## Command\n```bash\n# Check YAML syntax\npython3 -c 'import yaml; yaml.safe_load(open(\".github/workflows/ci.yml\"))'\npython3 -c 'import yaml; yaml.safe_load(open(\".github/workflows/release.yml\"))'\n```\n\n## Expected\n- No YAML syntax errors\n- Workflows parse successfully","notes":"env: local\nverify: agent\nmaps-to-ac: CI runs on PR","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:37:17.424949-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T11:40:31.57032-05:00","closed_at":"2026-01-27T11:40:31.57032-05:00","close_reason":"All workflow YAML files validated with Ruby YAML parser. ci.yml, release.yml, .goreleaser.yml all parse successfully.","labels":["L-186","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-h9g.2","depends_on_id":"lokt-h9g","type":"parent-child","created_at":"2026-01-27T11:37:17.427066-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-h9g.2","depends_on_id":"lokt-uyq.3","type":"blocks","created_at":"2026-01-27T11:37:28.57301-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-h9g.3","title":"L-186 verify:github push PR and check CI","description":"## Check\nVerify CI workflow runs correctly on GitHub.\n\n## Steps\n1. Push changes to a branch\n2. Open PR to main\n3. Verify CI runs on both ubuntu-latest and macos-latest\n4. Verify all jobs pass (test + lint on both OS)\n\n## Expected\n- CI triggered automatically on PR\n- Matrix shows 2 OS runners\n- All checks pass","notes":"env: github\nverify: human\nmaps-to-ac: CI runs on PR","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:37:19.748853-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:19:52.485026-05:00","closed_at":"2026-01-27T13:19:52.485026-05:00","close_reason":"CI passes on GitHub with ubuntu-latest and macos-latest matrix. All jobs green.","labels":["L-186","verification","verify-human"],"dependencies":[{"issue_id":"lokt-h9g.3","depends_on_id":"lokt-h9g","type":"parent-child","created_at":"2026-01-27T11:37:19.750977-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-h9g.3","depends_on_id":"lokt-uyq.1","type":"blocks","created_at":"2026-01-27T11:37:28.754872-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-h9g.4","title":"L-187 verify:github test release with pre-release tag","description":"## Check\nVerify release workflow creates GitHub Release with binaries.\n\n## Steps\n1. Create and push a test tag: git tag v0.0.1-test \u0026\u0026 git push origin v0.0.1-test\n2. Watch Actions tab for release workflow\n3. Verify GitHub Release created with:\n   - 4 binary archives (darwin/linux × amd64/arm64)\n   - checksums.txt file\n   - Auto-generated changelog\n4. Download a binary, run `lokt version`, verify output matches tag\n5. Delete test release and tag when done\n\n## Expected\n- Release workflow triggered by tag\n- All binaries present and downloadable\n- Version shows v0.0.1-test","notes":"env: github\nverify: human\nmaps-to-ac: Release on tag, Binaries work, Checksums present","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:37:22.154576-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:37:03.979869-05:00","closed_at":"2026-01-27T13:37:03.979869-05:00","close_reason":"Release workflow passed. GitHub Release created with 4 binary archives and checksums.txt.","labels":["L-187","verification","verify-human"],"dependencies":[{"issue_id":"lokt-h9g.4","depends_on_id":"lokt-h9g","type":"parent-child","created_at":"2026-01-27T11:37:22.15637-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-h9g.4","depends_on_id":"lokt-uyq.3","type":"blocks","created_at":"2026-01-27T11:37:28.920995-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-khv","title":"L-173 audit-since","description":"## Summary\nAdd `lokt audit --since` command to query audit events by time. Supports duration (1h, 30m) and RFC3339 timestamps. Optional --name filter.\n\n## Acceptance Criteria\n- [ ] `lokt audit --since 1h` shows events from last hour\n- [ ] `lokt audit --since 2026-01-27T10:00:00Z` shows events after timestamp\n- [ ] `--name build` filters to only \"build\" lock events\n- [ ] Output is valid JSONL\n- [ ] Missing audit.log handled gracefully (empty output, exit 0)\n- [ ] Invalid --since format shows helpful error\n\n## Plan\n\n### Strategy\nAdd cmdAudit to main.go. Parse --since as duration first, fallback to RFC3339. Read audit.log line by line, filter, output matches.\n\n### Patterns\n- Mirror: existing cmd functions in main.go (cmdLock, cmdStatus, etc.)\n- Reuse: time.ParseDuration, time.Parse(RFC3339)\n\n### Key Decisions\n- Duration-first parsing: try ParseDuration, then RFC3339\n- JSONL output: keep machine-readable, no pretty printing\n- Graceful empty: missing/empty log returns exit 0\n\n## Edge Cases\n- Audit log doesn't exist — empty output, exit 0\n- Malformed lines in audit log — skip and continue\n- No events match filter — empty output, exit 0\n\n## Constraints\n- Keep CLI consistent with existing commands\n- Use Go standard library for time parsing","notes":"source: _notes/story-drafts/l-173-audit-since.md\nverify-level: optional\nverify-envs: local","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:41:40.280684-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:53:37.532521-05:00","closed_at":"2026-01-27T18:53:37.532521-05:00","close_reason":"L-173 complete. audit --since command with duration/RFC3339 and --name filter. Also wired CLI to emit audit events.","labels":["L-173","story"]}
{"id":"lokt-khv.1","title":"L-173 cli: add audit command with --since and --name","description":"## What\nAdd cmdAudit function to main.go with --since and --name flags.\n\n## Why\nCore CLI for querying audit history.\n\n## Pattern\nMirror: existing cmd functions (cmdLock, cmdStatus)\n\n## Acceptance\n- [ ] `lokt audit --since 1h` parses duration and filters\n- [ ] `lokt audit --since 2026-01-27T10:00:00Z` parses RFC3339\n- [ ] `--name build` filters by lock name\n- [ ] Output is JSONL to stdout\n- [ ] Missing audit.log returns empty output, exit 0\n- [ ] Invalid --since shows error message","notes":"env: local\nverify: agent\nmaps-to-ac: since-duration, since-timestamp, name-filter, jsonl-output, missing-log, invalid-since","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:41:57.239526-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:49:08.938993-05:00","closed_at":"2026-01-27T18:49:08.938993-05:00","close_reason":"Added cmdAudit with --since (duration/RFC3339) and --name filters. Build passes.","labels":["L-173","task"],"dependencies":[{"issue_id":"lokt-khv.1","depends_on_id":"lokt-khv","type":"parent-child","created_at":"2026-01-27T18:41:57.242704-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-khv.2","title":"L-173 cli: add audit to help text and verify","description":"## What\nAdd audit command to usage() help text and verify functionality.\n\n## Why\nEnsure discoverability and correct behavior.\n\n## Acceptance\n- [ ] `lokt help` shows audit command with flags\n- [ ] Manual test: create events, query with --since\n- [ ] Manual test: --name filter works\n- [ ] Manual test: missing audit.log returns empty","notes":"env: local\nverify: agent\nmaps-to-ac: help-text","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T18:42:11.474287-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T18:53:25.746762-05:00","closed_at":"2026-01-27T18:53:25.746762-05:00","close_reason":"Added audit to help text. Verified: --since with duration and timestamp, --name filter, missing log returns empty. Also wired up auditor in CLI for lock/unlock/guard.","labels":["L-173","task"],"dependencies":[{"issue_id":"lokt-khv.2","depends_on_id":"lokt-khv","type":"parent-child","created_at":"2026-01-27T18:42:11.476861-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-khv.2","depends_on_id":"lokt-khv.1","type":"blocks","created_at":"2026-01-27T18:42:22.921444-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-ki7","title":"L-200 audit: add renew event type","description":"## What\nAdd `EventRenew = \"renew\"` constant to `internal/audit/audit.go`.\n\n## Why\nRenewals should be auditable for debugging and observability. The renew event uses the same structure as acquire/release events.\n\n## Pattern\nMirror: `internal/audit/audit.go` — existing event constants\n\n## Implementation\n1. Add `EventRenew = \"renew\"` to the event constants\n2. No other changes needed - the Event struct already supports this\n\n## Acceptance\n- [ ] `audit.EventRenew` constant exists\n- [ ] Value is \"renew\"","notes":"env: local\nverify: agent\nmaps-to-ac: audit-events-for-renewal","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:00:23.99446-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:03:17.505819-05:00","closed_at":"2026-01-28T09:03:17.505819-05:00","close_reason":"Added EventRenew constant to audit.go"}
{"id":"lokt-lb2","title":"L-103 lock-name-validation","description":"## Summary\nValidate lock names to prevent path traversal and invalid characters.\n\n## Acceptance Criteria\n- Valid names (alphanumeric, dots, hyphens, underscores) accepted\n- Path traversal (`../`) rejected with clear error\n- Absolute paths rejected\n- Empty names rejected\n- Special characters rejected\n\n## Plan\n\n### Strategy\nAdd a ValidateName function in internal/lockfile package, call it early in Acquire/Release.\n\n### Pattern\n- Regex: `^[A-Za-z0-9._-]+$`\n- Explicit check for `..` substring\n- Check for leading `/`\n\n## Edge Cases\n- `foo.bar` — valid\n- `foo..bar` — invalid (contains `..`)\n- `.hidden` — valid\n\n## Constraints\n- Validate before any file operations\n- Same validation for all commands","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T10:08:03.670899-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T10:13:17.660549-05:00","closed_at":"2026-01-27T10:13:17.660549-05:00","close_reason":"L-103 complete: ValidateName added, integrated, tested, pushed"}
{"id":"lokt-n4m","title":"L-210 hexwall: bash demo script via lokt demo","description":"## Summary\nImplement `lokt demo` — a CLI command that emits a self-contained, heavily-commented bash script (`lokt-hexwall-demo.sh`) into the current directory. The script spawns hundreds of worker processes that race to build a hex wall one character at a time using `lokt guard` for coordination. Running with `--no-lock` bypasses locking and shows visible corruption.\n\n## Acceptance Criteria\n- [ ] AC1: Clean wall in lock mode — 16-row hex wall, rows in order (0-f), each row formatted as `\u003cnibble\u003e | \u003cnibble x 32\u003e`, no duplicates/gaps/garbled lines\n- [ ] AC2: Garbled wall in no-lock mode — visibly broken output (wrong char counts, dupes, missing rows, garbled content)\n- [ ] AC3: Per-cell lock granularity — 512 lock acquisitions (16×32), each contested by up to 512 workers\n- [ ] AC4: Live streaming output — completed rows appear incrementally via tail -f\n- [ ] AC5: Custom dimensions — `--rows 256 --cols 64 --workers 128` produces 256 rows, 64 chars wide, 128 workers\n- [ ] AC6: Summary line — row count, col count, worker count, elapsed time after wall\n- [ ] AC7: Readable by non-bash-experts — every functional section has explanatory block comments\n- [ ] AC8: Cross-platform — macOS and Linux, bash 3.2+, no GNU-only utilities\n- [ ] AC9: Clean exit and cleanup — Ctrl-C kills workers, tail, removes STATE_DIR\n- [ ] AC10: User can modify and re-run — hackable artifact\n- [ ] AC11: `lokt demo` emits the script to cwd and prints instructions\n- [ ] AC12: Preflight catches missing lokt\n\n## Plan\n\n### Strategy\nThe Go CLI addition is minimal: add a `demo` case to the command switch that writes a string constant to `./lokt-hexwall-demo.sh` and chmod +x. The real work is crafting the bash script. The script uses per-cell contention (shared counter file under lokt guard), row buffer files, and tail -f for live output.\n\n### Patterns\n- Mirror: `cmd/lokt/main.go` switch-case command dispatch — add `demo` case\n- Mirror: `_notes/story-drafts/hexwall-demo.md` — script structure, critical section design\n- Convention: stdlib flag, no cobra, no external deps\n- Script is a string constant in Go source (no go:embed, no separate file)\n\n### Key Decisions\n- Script content as Go string constant (not go:embed) — keeps it in one file, easy to maintain\n- Per-cell contention model (not per-row) — every lock acquisition does real work, 512 total\n- Single-phase: claim + write under one guard invocation — strict ordering, simple\n- No ANSI, no TUI — plain text with tail -f streaming\n- critical.sh written to temp dir at startup — portable, debuggable\n- No bash 4+ features — works on macOS default bash 3.2\n\n## Edge Cases\n- lokt not on PATH: preflight error before spawning\n- Previous stale lock: workers use --ttl 30s, auto-expires\n- ROWS=0 or COLS=0: exit 0 immediately\n- WORKERS=1: works correctly, single worker claims all cells\n- Ctrl-C during spawn: trap kills only collected PIDs\n- Row buffer corruption in nolock: expected, that's the demo\n\n## Constraints\n- Go CLI only emits the file — no Go code runs during demo\n- Script must be self-contained (single file, no sourcing)\n- Critical section must be minimal (single-digit ms)\n- Comments are first-class deliverable\n- No bash 4+ features (no associative arrays, no ${var,,}, no readarray)","notes":"source: _notes/story-drafts/hexwall-demo.md\nverify-level: required\nverify-envs: local (macOS + Linux)\nbacklog-ref: docs/backlog.md L-210\nverify-epic: lokt-ssk","status":"open","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:02.670521-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:12:03.98729-05:00","labels":["L-210","story"]}
{"id":"lokt-n4m.1","title":"L-210 script: write the hexwall bash script as Go string constant","description":"## What\nWrite the complete lokt-hexwall-demo.sh bash script content as a Go string constant in a new file `cmd/lokt/demo.go`. This is the bulk of the work.\n\n## Why\nThe script IS the deliverable. It must be heavily commented, bash 3.2 compatible, cross-platform, and demonstrate lokt guard under extreme contention.\n\n## Pattern\nMirror: `_notes/story-drafts/hexwall-demo.md` technical design section for script structure.\n\n## Acceptance\n- [ ] Script content covers all sections: config/flags, preflight, critical.sh creation, tail -f output, cleanup trap, worker spawn, wait + summary\n- [ ] Per-cell contention model: shared counter, 512 cells default, all workers contest every cell\n- [ ] Every functional section has block comments explaining what, why, and what depends on it\n- [ ] Comments are conversational (annotated tutorial tone), not terse\n- [ ] Bash 3.2 compatible: no associative arrays, no ${var,,}, no readarray, no declare -f in guard\n- [ ] Cross-platform: mktemp -d works on macOS and Linux, no GNU-only flags\n- [ ] Flags: --workers, --rows, --cols, --no-lock, --lock-name, --help\n- [ ] Env var overrides (WORKERS=256 ./script.sh), flags take precedence\n- [ ] Lock mode uses: lokt guard \u003cname\u003e --ttl 30s -- bash critical.sh \u003cargs\u003e\n- [ ] No-lock mode runs: bash critical.sh \u003cargs\u003e directly\n- [ ] Output format: `\u003cnibble\u003e | \u003cnibble x cols\u003e` per row\n- [ ] Summary line: `hexwall: N rows x M cols, W workers, Xs`\n- [ ] Clean exit on Ctrl-C: kill tail, kill workers, rm STATE_DIR","status":"in_progress","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:19.362673-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:18:03.977149-05:00","labels":["L-210","task"],"dependencies":[{"issue_id":"lokt-n4m.1","depends_on_id":"lokt-n4m","type":"parent-child","created_at":"2026-01-29T23:11:19.364942-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-n4m.2","title":"L-210 cli: add lokt demo command to emit the script","description":"## What\nAdd the `demo` subcommand to cmd/lokt/main.go that writes lokt-hexwall-demo.sh to the current directory and prints instructions.\n\n## Why\n`lokt demo` is the delivery mechanism. It writes the script file, chmod +x, and tells the user what to do next.\n\n## Pattern\nMirror: `cmd/lokt/main.go` switch-case dispatch pattern. Add `case \"demo\":` calling a `cmdDemo()` function.\n\n## Acceptance\n- [ ] `lokt demo` writes `./lokt-hexwall-demo.sh` with the script content\n- [ ] File is chmod 0755\n- [ ] If file already exists, overwrite it (no prompt)\n- [ ] Prints: `Wrote lokt-hexwall-demo.sh` + usage instructions\n- [ ] `lokt demo --help` shows usage\n- [ ] `demo` command added to main switch and usage() help text\n- [ ] Script content from demo.go string constant\n- [ ] Tests: go test passes, golangci-lint clean","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:25.655455-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:11:25.655455-05:00","labels":["L-210","task"],"dependencies":[{"issue_id":"lokt-n4m.2","depends_on_id":"lokt-n4m","type":"parent-child","created_at":"2026-01-29T23:11:25.657748-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-n4m.2","depends_on_id":"lokt-n4m.1","type":"blocks","created_at":"2026-01-29T23:11:39.644275-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-n4m.3","title":"L-210 test: integration test for lokt demo output","description":"## What\nAdd a Go test that verifies `lokt demo` writes a valid, executable script file. Optionally, if lokt binary is available, run the script with small grid to verify clean output.\n\n## Why\nPrevents regressions in the script content or the emit mechanism.\n\n## Pattern\nMirror: existing test patterns in the project.\n\n## Acceptance\n- [ ] Test calls cmdDemo() and verifies file is written with correct permissions\n- [ ] Test verifies script starts with #!/usr/bin/env bash\n- [ ] Test verifies script contains key sections (preflight, critical section, worker spawn)\n- [ ] golangci-lint clean","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:29.876735-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:11:29.876735-05:00","labels":["L-210","task"],"dependencies":[{"issue_id":"lokt-n4m.3","depends_on_id":"lokt-n4m","type":"parent-child","created_at":"2026-01-29T23:11:29.878719-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-n4m.3","depends_on_id":"lokt-n4m.2","type":"blocks","created_at":"2026-01-29T23:11:41.831556-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-p67","title":"lokt-al5 cli: add --json output to why command","description":"## What\nAdd --json flag support to cmdWhy, producing structured JSON output with reasons array and suggestions array.\n\n## Why\nAI agents (primary consumer) need machine-parseable output to make autonomous recovery decisions.\n\n## Pattern\nMirror: lockToStatusOutput / statusOutput for JSON struct patterns.\nMirror: cmdDoctor jsonOutput flag handling.\n\n## Implementation\n\n1. Define whyOutput struct with JSON tags:\n   - name, status (\"free\"/\"blocked\"), reasons (array), suggestions (array)\n2. Define whyReason struct:\n   - type (frozen/held/expired/dead_pid/corrupted/self_held), message, plus type-specific fields\n3. Wire --json flag in cmdWhy to output JSON instead of text\n4. Ensure all scenarios produce valid, parseable JSON\n\n## Acceptance\n- [ ] `lokt why --json \u003cname\u003e` produces valid JSON for all scenarios\n- [ ] JSON includes: name, status, reasons[], suggestions[]\n- [ ] Each reason has type, message, and type-specific metadata fields\n- [ ] Free lock produces `{\"name\":\"...\",\"status\":\"free\",\"reasons\":[],\"suggestions\":[]}`","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:12:05.193133-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:19:08.5678-05:00","closed_at":"2026-01-28T22:19:08.5678-05:00","close_reason":"JSON output implemented as part of core cmdWhy. --json flag produces structured whyOutput with reasons[] and suggestions[].","dependencies":[{"issue_id":"lokt-p67","depends_on_id":"lokt-pne","type":"blocks","created_at":"2026-01-28T22:12:20.09188-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-pbi","title":"lokt-al5 verify:sandbox json output","description":"## Check\nlokt why --json produces valid, parseable JSON with correct schema.\n\n## Commands\nlokt why --json nonexistent     # free case\nlokt lock test-json --ttl 5m\nlokt why --json test-json       # held case\nlokt unlock test-json\n\n## Expected\n- Both outputs are valid JSON (parseable by jq)\n- Free case: status=\"free\", empty reasons\n- Held case: status=\"blocked\", reasons array with type/message, suggestions array","notes":"env: sandbox\nverify: agent\nmaps-to-ac: json-output","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:12:44.457115-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:22:44.600369-05:00","closed_at":"2026-01-28T22:22:44.600369-05:00","close_reason":"Verified: --json output is valid JSON with name/status/reasons/suggestions schema","dependencies":[{"issue_id":"lokt-pbi","depends_on_id":"lokt-p67","type":"blocks","created_at":"2026-01-28T22:12:54.043862-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-pne","title":"lokt-al5 cli: implement cmdWhy with text output","description":"## What\nImplement the core `cmdWhy(args []string) int` function in cmd/lokt/main.go. This is the main implementation task.\n\n## Why\nThis is the primary deliverable — the diagnostic command that reads lock state and explains denial reasons.\n\n## Pattern\nMirror: cmdDoctor for flag parsing + text output structure.\nMirror: showLock for lock metadata display.\nRead freeze file directly (not via CheckFreeze) to avoid side effects.\n\n## Implementation\n\n1. Add `case \"why\": code = cmdWhy(args)` to main switch\n2. Add `cmdWhy` function:\n   - flag.NewFlagSet with --json flag\n   - Validate name via lockfile.ValidateName()\n   - root.Find() for root discovery\n   - Read freeze lock: lockfile.Read(root.LockFilePath(rootDir, \"freeze-\"+name))\n   - Read regular lock: lockfile.Read(root.LockFilePath(rootDir, name))\n   - Get current identity: identity.Current() (imported new)\n   - Run stale.Check() on lock if it exists\n   - Classify reasons and build suggestions\n   - Format text output\n3. Update usage() to include `why` command\n\n## Acceptance\n- [ ] `lokt why \u003cname\u003e` works for all scenarios: free, held, frozen, expired, dead PID, corrupted, self-held\n- [ ] Correct exit codes: 0 (free), 2 (blocked), 64 (usage)\n- [ ] Text output shows structured diagnosis with reasons + suggestions\n- [ ] No file mutations or audit writes\n- [ ] Name validation rejects invalid names","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:11:59.045238-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:19:08.374972-05:00","closed_at":"2026-01-28T22:19:08.374972-05:00","close_reason":"Implemented cmdWhy in cmd/lokt/main.go. All scenarios working: free, held (alive/dead/cross-host), frozen, corrupted, self-held. Text + JSON output. Lint clean."}
{"id":"lokt-q0l","title":"L-202 verify:sandbox","description":"Verification for L-202 doctor health check\n\nLinked story: lokt-8s7\n\n## Scope\n- Agent-verifiable: CLI output, exit codes, JSON format\n- Human-verifiable: none (all can be automated)\n\n## Environments\nsandbox","notes":"linked-story: lokt-8s7\nverify-level: optional","status":"closed","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:30:55.551769-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:46:56.478925-05:00","closed_at":"2026-01-28T09:46:56.478925-05:00","close_reason":"L-202 complete: lokt doctor command implemented and verified","labels":["L-202","verification"]}
{"id":"lokt-q0l.1","title":"L-202 verify:sandbox writability check","description":"## Check\nVerify doctor reports OK for writable directory.\n\n## Command\n```bash\nlokt doctor\n```\n\n## Expected\n- Output contains \"[OK]\" or \"ok\" for writability check\n- Exit code 0","notes":"env: sandbox\nverify: agent\nmaps-to-ac: Writability check","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:31:09.320135-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:39:15.328666-05:00","closed_at":"2026-01-28T09:39:15.328666-05:00","close_reason":"Verified: doctor command works correctly, JSON valid, exit codes correct","labels":["L-202","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-q0l.1","depends_on_id":"lokt-q0l","type":"parent-child","created_at":"2026-01-28T09:31:09.32611-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-q0l.2","title":"L-202 verify:sandbox JSON output valid","description":"## Check\nVerify --json produces valid JSON with expected structure.\n\n## Command\n```bash\nlokt doctor --json | jq .\n```\n\n## Expected\n- Valid JSON (jq succeeds)\n- Contains root_method, root_path, checks array, overall\n- Exit code 0","notes":"env: sandbox\nverify: agent\nmaps-to-ac: JSON output","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:31:13.359827-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:39:15.358509-05:00","closed_at":"2026-01-28T09:39:15.358509-05:00","close_reason":"Verified: doctor command works correctly, JSON valid, exit codes correct","labels":["L-202","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-q0l.2","depends_on_id":"lokt-q0l","type":"parent-child","created_at":"2026-01-28T09:31:13.367617-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-q0l.3","title":"L-202 verify:sandbox root discovery reporting","description":"## Check\nVerify doctor reports the root discovery method and path.\n\n## Command\n```bash\nlokt doctor --json | jq -r '.root_method, .root_path'\n```\n\n## Expected\n- root_method is one of: env, git, local\n- root_path is a valid absolute path\n- Path matches what `lokt status` would use","notes":"env: sandbox\nverify: agent\nmaps-to-ac: Root discovery reporting","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:31:17.187545-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:39:15.386276-05:00","closed_at":"2026-01-28T09:39:15.386276-05:00","close_reason":"Verified: doctor command works correctly, JSON valid, exit codes correct","labels":["L-202","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-q0l.3","depends_on_id":"lokt-q0l","type":"parent-child","created_at":"2026-01-28T09:31:17.197651-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-q49","title":"L-200 verify:sandbox audit log shows renew events","description":"## Check\nVerify that renew events are written to the audit log.\n\n## Command\n```bash\n# Clear/note current audit log position\n./lokt guard --ttl 2s test-audit -- sleep 5\n\n# Check audit log for renew events\n./lokt audit --since 1m --name test-audit | grep '\"event\":\"renew\"'\n```\n\n## Expected\n- Audit log should contain 'renew' events for the test lock\n- At least 1 renew event during a 5s command with 2s TTL","notes":"env: sandbox\nverify: agent\nmaps-to-ac: audit-events-for-renewal","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:01:09.814184-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T15:52:50.842318-05:00","closed_at":"2026-01-28T15:52:50.842318-05:00","close_reason":"Verified: guard with --ttl 2s emitted 6 renew events during 6s sleep. Audit log shows correct renew event type with owner/host/pid/ttl fields."}
{"id":"lokt-qxd","title":"lokt-al5 why-command: diagnostic CLI for lock denial","description":"## Summary\n\nAdd `lokt why \u003cname\u003e` — a read-only diagnostic command that explains exactly why a lock cannot be acquired and suggests recovery actions. Covers all denial scenarios: held, frozen, expired, dead PID, corrupted, cross-host. Supports `--json` for AI agent consumption.\n\nSource story: _notes/story-drafts/lokt-al5-why-command.md\nParent issue: lokt-al5\n\n## Acceptance Criteria\n\n- [ ] **Free lock**: exit 0, states acquisition would succeed\n- [ ] **Held (same host, alive)**: shows holder, PID alive, age, suggests --wait/--force\n- [ ] **Held (cross-host)**: shows holder, notes PID unverifiable, suggests --wait/--force/--break-stale\n- [ ] **Frozen**: shows freeze owner, remaining TTL, suggests wait/unfreeze\n- [ ] **Frozen + held**: reports both, freeze first\n- [ ] **Expired TTL**: notes expired, suggests --break-stale or --wait (auto-prune)\n- [ ] **Dead PID (same host)**: notes PID dead, suggests --break-stale\n- [ ] **Corrupted**: notes corruption, suggests --force\n- [ ] **Self-held**: notes \"you already hold this lock\"\n- [ ] **--json**: valid JSON with name, status, reasons[], suggestions[]\n- [ ] **Exit codes**: 0 (free), 2 (blocked), 3 (bad name/root), 64 (usage)\n\n## Plan\n\n### Strategy\n\nPure read-only diagnostic. No file mutations, no audit writes. Read lock file + freeze file directly, run stale.Check(), compare identity, format output. All infrastructure already exists — this is formatting + a new CLI entrypoint.\n\n### Key Decisions\n\n1. **Don't use lock.CheckFreeze()**: It auto-prunes expired freezes and emits audit events. Instead, read freeze lock file directly via lockfile.Read() and check expiry manually.\n2. **Don't use lock.Acquire()**: This is not an acquisition attempt. Read lock file via lockfile.Read() + stale.Check() for analysis.\n3. **Self-held detection**: Compare current identity (identity.Current()) against lock holder.\n4. **Multiple reasons array**: A lock can be both frozen AND held. Report all reasons, freeze first.\n5. **ValidateName via lockfile.ValidateName()**: Same validation as all other commands.\n\n### Patterns\n\n- Mirror: `cmdDoctor` for --json flag pattern and text formatting style\n- Mirror: `showLock` / `lockToStatusOutput` for lock metadata display\n- Mirror: `pidLiveness` helper for PID status strings\n- New: `cmdWhy` function in cmd/lokt/main.go, added to switch statement and usage()\n\n### Task Breakdown\n\n1. Core `cmdWhy` implementation — read lock + freeze, classify denial reason, format text output\n2. JSON output support — `--json` flag with structured reasons/suggestions schema\n3. Tests — unit tests covering all denial scenarios\n4. Usage/help update — add `why` to usage() and switch statement\n\n## Edge Cases\n\n- Lock disappears between read and output — acceptable; best-effort snapshot\n- Freeze expired — report as not frozen (don't auto-prune, that's a side effect)\n- Self-held — special message \"you already hold this lock\"\n- No lokt root — clear error, suggest `lokt doctor`\n\n## Constraints\n\n- Read-only: no file mutations, no audit writes\n- Reuse: lockfile.Read(), stale.Check(), identity.Current(), lockfile.ValidateName()\n- Single file: all implementation in cmd/lokt/main.go","status":"closed","priority":1,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:11:44.696887-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:22:52.948714-05:00","closed_at":"2026-01-28T22:22:52.948714-05:00","close_reason":"All 3 implementation tasks + 4 verification tasks complete. Command implemented with 20 tests."}
{"id":"lokt-scl","title":"Freeze Switch: freeze/unfreeze commands","description":"## Summary\nImplement freeze/unfreeze commands as advertised in README. Freeze creates a special lock (freeze-\u003cname\u003e) that blocks all guard commands for that name until unfreeze or TTL expiry.\n\n## Acceptance Criteria\n- lokt freeze \u003cname\u003e --ttl \u003cdur\u003e creates freeze-\u003cname\u003e lock atomically\n- lokt unfreeze \u003cname\u003e releases freeze lock (owner-checked, --force supported)\n- lokt guard \u003cname\u003e aborts if active freeze-\u003cname\u003e exists (auto-prunes expired)\n- lokt status shows freeze locks with [FROZEN] label and freeze:true in JSON\n- Audit events: freeze, unfreeze, force-unfreeze, freeze-deny\n\n## Plan\n\n### Strategy\nFreeze is a special lock: same atomic create semantics, same lockfile format. The freeze- prefix is the convention. Guard checks for freeze before acquiring.\n\n### Patterns\n- Mirror: lock/acquire.go for freeze creation\n- Mirror: lock/release.go for unfreeze\n- Mirror: cmdLock/cmdUnlock in main.go for CLI commands\n\n### Key Decisions\n- Naming: freeze-\u003cname\u003e.json in locks/ dir (reuses existing infrastructure)\n- TTL required for freeze (safety: no infinite blocks)\n- Guard exits with ExitLockHeld (exit code 2) when frozen\n- New exit code not needed: frozen is semantically 'held'\n\n## Edge Cases\n- freeze without --ttl should error (require TTL for safety)\n- freeze on already-frozen name: deny like regular lock\n- unfreeze non-existent freeze: return not-found\n- guard encounters expired freeze: auto-prune and proceed","status":"closed","priority":1,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:13.52011-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:42:20.103296-05:00","closed_at":"2026-01-28T16:42:20.103296-05:00","close_reason":"Closed"}
{"id":"lokt-scl.1","title":"L-160 audit: add freeze/unfreeze event types","description":"Add EventFreeze, EventUnfreeze, EventForceUnfreeze, EventFreezeDeny constants to internal/audit/audit.go. Mirror existing event pattern.","status":"tombstone","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:26.966088-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:33:55.459758-05:00","deleted_at":"2026-01-28T16:33:55.459758-05:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"lokt-scl.10","title":"L-164 cli: status highlights freezes","description":"Status shows [FROZEN] label and freeze:true in JSON.","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:36.180851-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:42:12.392237-05:00","closed_at":"2026-01-28T16:42:12.392237-05:00","close_reason":"Closed","dependencies":[{"issue_id":"lokt-scl.10","depends_on_id":"lokt-scl","type":"parent-child","created_at":"2026-01-28T16:33:36.188138-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-scl.10","depends_on_id":"lokt-scl.8","type":"blocks","created_at":"2026-01-28T16:33:42.205528-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-scl.2","title":"L-164 cli: status highlights freeze locks","description":"In cmdStatus, detect freeze-\u003cname\u003e locks and show [FROZEN] label in text output and freeze:true in JSON output.","status":"tombstone","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:26.974959-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:33:55.596571-05:00","deleted_at":"2026-01-28T16:33:55.596571-05:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"lokt-scl.3","title":"L-162 cli: guard checks freeze before acquiring","description":"In cmdGuard, before acquiring the lock, check if freeze-\u003cname\u003e exists and is not expired. If frozen, emit freeze-deny audit event and exit with ExitLockHeld. Auto-prune expired freezes.","status":"tombstone","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:26.975246-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:33:55.734155-05:00","deleted_at":"2026-01-28T16:33:55.734155-05:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"lokt-scl.4","title":"L-160 cli: add freeze and unfreeze commands","description":"Add cmdFreeze and cmdUnfreeze to cmd/lokt/main.go. Wire into main switch. Add usage text. Freeze requires --ttl flag.","status":"tombstone","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:26.985628-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:33:55.868564-05:00","deleted_at":"2026-01-28T16:33:55.868564-05:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"lokt-scl.5","title":"L-160 lock: add freeze/unfreeze functions","description":"Add Freeze() and Unfreeze() functions in internal/lock/freeze.go. Freeze creates freeze-\u003cname\u003e lock atomically with required TTL. Unfreeze releases with owner check and --force. Add CheckFreeze() for guard integration.","status":"tombstone","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:26.986073-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:33:56.00595-05:00","deleted_at":"2026-01-28T16:33:56.00595-05:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"lokt-scl.6","title":"L-160 audit: add freeze event types","description":"Add freeze/unfreeze event constants to audit package.","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:35.467606-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:34:29.767277-05:00","closed_at":"2026-01-28T16:34:29.767277-05:00","close_reason":"Closed","dependencies":[{"issue_id":"lokt-scl.6","depends_on_id":"lokt-scl","type":"parent-child","created_at":"2026-01-28T16:33:35.471353-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-scl.7","title":"L-160 lock: freeze/unfreeze functions","description":"Add Freeze/Unfreeze/CheckFreeze in internal/lock/freeze.go.","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:35.622698-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:35:21.642492-05:00","closed_at":"2026-01-28T16:35:21.642492-05:00","close_reason":"Closed","dependencies":[{"issue_id":"lokt-scl.7","depends_on_id":"lokt-scl","type":"parent-child","created_at":"2026-01-28T16:33:35.632793-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-scl.7","depends_on_id":"lokt-scl.6","type":"blocks","created_at":"2026-01-28T16:33:41.777636-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-scl.8","title":"L-160 cli: freeze and unfreeze commands","description":"Add cmdFreeze/cmdUnfreeze to main.go, wire into switch.","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:35.783536-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:42:12.271928-05:00","closed_at":"2026-01-28T16:42:12.271928-05:00","close_reason":"Closed","dependencies":[{"issue_id":"lokt-scl.8","depends_on_id":"lokt-scl","type":"parent-child","created_at":"2026-01-28T16:33:35.797371-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-scl.8","depends_on_id":"lokt-scl.7","type":"blocks","created_at":"2026-01-28T16:33:41.921999-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-scl.9","title":"L-162 cli: guard checks freeze","description":"Guard aborts if active freeze exists, auto-prunes expired.","status":"closed","priority":1,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T16:33:36.001982-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T16:42:12.333329-05:00","closed_at":"2026-01-28T16:42:12.333329-05:00","close_reason":"Closed","dependencies":[{"issue_id":"lokt-scl.9","depends_on_id":"lokt-scl","type":"parent-child","created_at":"2026-01-28T16:33:36.004355-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-scl.9","depends_on_id":"lokt-scl.8","type":"blocks","created_at":"2026-01-28T16:33:42.066467-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-skc","title":"Idempotent reentrant acquire (owner-matched lock refresh)","description":"When lokt lock is called and the lock is already held by the same LOKT_OWNER, refresh the TTL and exit 0 instead of failing with exit 2. When owner matches: overwrite lock file with fresh TTL. When owner differs and TTL not expired: exit 2. When owner differs but TTL expired: evict and acquire. This eliminates the TOCTOU race in check-then-acquire patterns and collapses hook scripts from ~33 lines to ~8.","status":"open","priority":1,"issue_type":"feature","owner":"nikolasavic@gmail.com","created_at":"2026-01-30T19:19:01.517066-05:00","created_by":"Nikola Savic","updated_at":"2026-01-30T19:19:01.517066-05:00"}
{"id":"lokt-ssk","title":"L-210 verify:local","description":"Verification for L-210 Hexwall demo.\n\nLinked story: lokt-n4m\n\n## Scope\n- Agent-verifiable: build, script emit, lock-mode run, no-lock-mode run, custom dimensions, cleanup\n- Human-verifiable: visual output correctness, readability of comments\n\n## Environments\nlocal (macOS + Linux)","notes":"linked-story: lokt-n4m\nverify-level: required\nverify-envs: local","status":"open","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:33.493505-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:11:33.493505-05:00","labels":["L-210","verification"]}
{"id":"lokt-ssk.1","title":"L-210 verify:local build and tests pass","description":"## Check\nBuild with ./scripts/build.sh and run go test ./... \u0026\u0026 golangci-lint run.\n\n## Command\n```bash\n./scripts/build.sh \u0026\u0026 go test ./... \u0026\u0026 golangci-lint run\n```\n\n## Expected\nAll pass with zero errors.","notes":"env: local\nverify: agent\nmaps-to-ac: AC11","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:43.792366-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:11:43.792366-05:00","labels":["L-210","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-ssk.1","depends_on_id":"lokt-ssk","type":"parent-child","created_at":"2026-01-29T23:11:43.79477-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-ssk.2","title":"L-210 verify:local lokt demo emits script","description":"## Check\n`lokt demo` creates lokt-hexwall-demo.sh in cwd with correct permissions.\n\n## Command\n```bash\ncd /tmp/lokt-verify \u0026\u0026 lokt demo \u0026\u0026 ls -la lokt-hexwall-demo.sh \u0026\u0026 head -3 lokt-hexwall-demo.sh\n```\n\n## Expected\n- File exists with executable permissions\n- Starts with #!/usr/bin/env bash\n- Instructions printed to stdout","notes":"env: local\nverify: agent\nmaps-to-ac: AC11","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:46.218467-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:11:46.218467-05:00","labels":["L-210","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-ssk.2","depends_on_id":"lokt-ssk","type":"parent-child","created_at":"2026-01-29T23:11:46.220814-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-ssk.3","title":"L-210 verify:local lock mode produces clean wall","description":"## Check\nRunning the script with default settings produces a clean 16-row hex wall.\n\n## Command\n```bash\n./lokt-hexwall-demo.sh --rows 4 --cols 8 --workers 16\n```\n\n## Expected\n- 4 rows of output, each formatted as `\u003cnibble\u003e | \u003cnibble x 8\u003e`\n- Rows in order: 0, 1, 2, 3\n- No garbled lines, no duplicates\n- Summary line at end","notes":"env: local\nverify: agent\nmaps-to-ac: AC1,AC4,AC6","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:50.258475-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:11:50.258475-05:00","labels":["L-210","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-ssk.3","depends_on_id":"lokt-ssk","type":"parent-child","created_at":"2026-01-29T23:11:50.261482-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-ssk.4","title":"L-210 verify:local no-lock mode shows corruption","description":"## Check\nRunning with --no-lock produces visibly broken output.\n\n## Command\n```bash\n./lokt-hexwall-demo.sh --no-lock --rows 16 --cols 32 --workers 512\n```\n\n## Expected\n- Output differs from lock mode: garbled lines, wrong character counts, duplicates, or missing rows\n- Script completes (does not hang)","notes":"env: local\nverify: agent\nmaps-to-ac: AC2","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:52.641911-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:11:52.641911-05:00","labels":["L-210","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-ssk.4","depends_on_id":"lokt-ssk","type":"parent-child","created_at":"2026-01-29T23:11:52.644643-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-ssk.5","title":"L-210 verify:local script comments are readable","description":"## Check\nRead the emitted script and verify every functional section has explanatory block comments.\n\n## Steps\n1. Run `lokt demo` to emit script\n2. Open lokt-hexwall-demo.sh\n3. Check each section: config, preflight, critical.sh, tail, cleanup, workers, wait\n\n## Expected\n- Every section has a block comment starting with # ──\n- Comments explain what, why, and what depends on it\n- Conversational tone, not terse","notes":"env: local\nverify: human\nmaps-to-ac: AC7,AC10","status":"open","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-29T23:11:56.089329-05:00","created_by":"Nikola Savic","updated_at":"2026-01-29T23:11:56.089329-05:00","labels":["L-210","verification","verify-human"],"dependencies":[{"issue_id":"lokt-ssk.5","depends_on_id":"lokt-ssk","type":"parent-child","created_at":"2026-01-29T23:11:56.096617-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-uyq","title":"L-186/187 github-release-pipeline","description":"## Summary\nAutomated CI/CD pipeline: tests on PR/push (Linux + macOS matrix), and goreleaser-based releases on version tags with cross-platform binaries.\n\n## Acceptance Criteria\n- [ ] CI runs on PR: tests pass on ubuntu-latest and macos-latest\n- [ ] CI runs on push to main: build + test succeeds\n- [ ] Release on tag: v* tag triggers GitHub Release with binaries\n- [ ] Binaries work: lokt version shows correct version/commit/date\n- [ ] Checksums present: SHA256 sums in checksums.txt match binaries\n\n## Plan\n\n### Strategy\nExtend existing ci.yml with macOS matrix. Add release.yml workflow using goreleaser action. Configure .goreleaser.yml with same ldflags pattern as scripts/build.sh.\n\n### Patterns\n- Mirror: `scripts/build.sh` for ldflags: -X main.version, -X main.commit, -X main.date\n- goreleaser archives as tar.gz with platform-specific naming\n\n### Key Decisions\n- No Windows: stale detection is Unix-only\n- No Homebrew: future work (non-goal per story)\n- No signing: deferred\n\n## Edge Cases\n- Tag without v prefix: ignored, no release\n- Failed tests on release: release aborted\n- Concurrent releases: goreleaser handles atomically\n\n## Constraints\n- GitHub-hosted runners (free for public repos)\n- goreleaser for cross-compilation\n- Same ldflags as scripts/build.sh","notes":"source: _notes/story-drafts/l-186-187-github-release-pipeline.md\nverify-level: required\nverify-envs: sandbox","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:36:21.396744-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:37:09.962313-05:00","closed_at":"2026-01-27T13:37:09.962313-05:00","close_reason":"L-186/187 complete. CI matrix + goreleaser release pipeline working.","labels":["L-186","L-187","story"]}
{"id":"lokt-uyq.1","title":"L-186 ci: add macOS matrix to CI workflow","description":"## What\nUpdate .github/workflows/ci.yml to run tests on both ubuntu-latest and macos-latest using a matrix strategy.\n\n## Why\nStory requirement: CI must pass on both Linux and macOS.\n\n## Pattern\nMirror existing ci.yml structure, add matrix.os.\n\n## Acceptance\n- [ ] CI workflow uses matrix with [ubuntu-latest, macos-latest]\n- [ ] Both OS runners execute test and lint jobs\n- [ ] Workflow passes on both platforms","notes":"env: local\nverify: agent\nmaps-to-ac: CI runs on PR, CI runs on push","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:36:36.892571-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T11:40:19.900097-05:00","closed_at":"2026-01-27T11:40:19.900097-05:00","close_reason":"Added matrix strategy to ci.yml with [ubuntu-latest, macos-latest]. Both OS runners execute test and lint jobs. YAML validated.","labels":["L-186","task"],"dependencies":[{"issue_id":"lokt-uyq.1","depends_on_id":"lokt-uyq","type":"parent-child","created_at":"2026-01-27T11:36:36.894386-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-uyq.2","title":"L-186 release: create goreleaser config","description":"## What\nCreate .goreleaser.yml with builds for darwin/linux on amd64/arm64, tar.gz archives, and checksums.\n\n## Why\ngoreleaser handles cross-compilation and release artifact creation.\n\n## Pattern\nMirror: `scripts/build.sh` for ldflags\n\n## Acceptance\n- [ ] .goreleaser.yml exists with darwin+linux builds\n- [ ] ldflags match scripts/build.sh (-X main.version, etc.)\n- [ ] Archive format is tar.gz with lokt_{version}_{os}_{arch} naming\n- [ ] checksums.txt configured","notes":"env: local\nverify: agent\nmaps-to-ac: Binaries work, Checksums present","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:36:39.237743-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T11:40:22.221304-05:00","closed_at":"2026-01-27T11:40:22.221304-05:00","close_reason":"Created .goreleaser.yml with darwin+linux builds on amd64/arm64. ldflags match scripts/build.sh. tar.gz archives with lokt_{version}_{os}_{arch} naming. checksums.txt configured.","labels":["L-186","task"],"dependencies":[{"issue_id":"lokt-uyq.2","depends_on_id":"lokt-uyq","type":"parent-child","created_at":"2026-01-27T11:36:39.241401-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-uyq.3","title":"L-187 release: create release workflow","description":"## What\nCreate .github/workflows/release.yml triggered by v* tags, running goreleaser to create GitHub Release with binaries.\n\n## Why\nAutomated releases on tag push, no manual steps.\n\n## Pattern\nStandard goreleaser GitHub Action pattern.\n\n## Acceptance\n- [ ] release.yml triggers on push of v* tags\n- [ ] Workflow uses goreleaser-action\n- [ ] Release workflow requires tests to pass first\n- [ ] GitHub Release created with binaries attached","notes":"env: local\nverify: agent\nmaps-to-ac: Release on tag","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T11:36:41.888144-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T11:40:24.512064-05:00","closed_at":"2026-01-27T11:40:24.512064-05:00","close_reason":"Created release.yml triggered on v* tags. Uses goreleaser-action v6. Tests run first (needs: test). Creates GitHub Release with binaries.","labels":["L-187","task"],"dependencies":[{"issue_id":"lokt-uyq.3","depends_on_id":"lokt-uyq","type":"parent-child","created_at":"2026-01-27T11:36:41.890654-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-uyq.3","depends_on_id":"lokt-uyq.2","type":"blocks","created_at":"2026-01-27T11:36:48.842199-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-v03","title":"L-188 install-script","description":"## Summary\ncurl | sh install script that downloads the correct lokt binary for OS/arch from GitHub Releases.\n\n## Acceptance Criteria\n- [ ] Basic install: curl -fsSL .../install.sh | sh installs lokt to install dir\n- [ ] Linux support: correct binary downloaded on Linux amd64/arm64\n- [ ] Version pin: LOKT_VERSION=v1.0.0 installs specific version\n- [ ] Checksum verify: exits non-zero on mismatch\n- [ ] Unsupported platform: clear error on Windows/unsupported arch\n- [ ] Idempotent: re-running updates binary without errors\n\n## Plan\n\n### Strategy\nSingle POSIX sh script with function wrapping for partial-download safety. Detect OS/arch, fetch from GitHub Releases, verify checksum, install to user-writable location.\n\n### Patterns\n- Mirror: `util/install-hooks.sh` — case/esac structure, clean messaging\n- goreleaser naming: `lokt_{version}_{os}_{arch}.tar.gz`\n\n### Key Decisions\n- POSIX sh (not bash): maximum compatibility\n- Function wrapping: prevents partial execution attacks\n- Install precedence: LOKT_INSTALL_DIR \u003e ~/.local/bin \u003e /usr/local/bin (with sudo)\n\n## Edge Cases\n- GitHub rate limiting: detect 403/429, suggest GITHUB_TOKEN\n- No curl/wget: check availability first\n- No write permission: suggest sudo or different dir\n- Checksum tool missing: try sha256sum, shasum, openssl\n\n## Constraints\n- POSIX sh compatible\n- No obfuscation (auditable)\n- GitHub releases URL: https://github.com/nikolasavic/lokt/releases/download/{tag}/lokt_{version}_{os}_{arch}.tar.gz","notes":"source: _notes/story-drafts/l-188-install-script.md\nverify-level: optional\nverify-envs: sandbox","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T21:00:52.046359-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:54:36.276259-05:00","closed_at":"2026-01-28T22:54:36.276259-05:00","close_reason":"All tasks and verification complete. Install bugs fixed in 5280f65.","labels":["L-188","story"]}
{"id":"lokt-v03.1","title":"L-188 script: create install.sh","description":"## What\nCreate the main install.sh script with:\n- POSIX sh shebang\n- Function wrapping (main function called at end)\n- OS detection (uname)\n- Arch detection (uname -m → amd64/arm64 mapping)\n- Download tool detection (curl vs wget)\n- Checksum tool detection (sha256sum vs shasum vs openssl)\n\n## Why\nCore implementation of the install script.\n\n## Pattern\nMirror: `util/install-hooks.sh` for case/esac and messaging style\n\n## Acceptance\n- [ ] Script detects darwin/linux correctly\n- [ ] Script detects amd64/arm64 correctly\n- [ ] Script fails clearly on unsupported platforms\n- [ ] Script wrapped in main() function","notes":"env: local\nverify: agent\nmaps-to-ac: Basic install, Linux support, Unsupported platform","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T21:01:12.990916-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T21:30:11.136933-05:00","closed_at":"2026-01-27T21:30:11.136933-05:00","close_reason":"Created scripts/install.sh with POSIX sh, function wrapping, OS/arch detection (darwin/linux, amd64/arm64), download tool detection (curl/wget), checksum tool detection (sha256sum/shasum/openssl). Shellcheck passes.","labels":["L-188","task"],"dependencies":[{"issue_id":"lokt-v03.1","depends_on_id":"lokt-v03","type":"parent-child","created_at":"2026-01-27T21:01:12.996214-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-v03.2","title":"L-188 script: add download and checksum","description":"## What\nAdd GitHub Releases download logic:\n- Fetch latest release tag via GitHub API (or use LOKT_VERSION)\n- Download tarball and checksums.txt\n- Verify SHA256 checksum\n- Extract binary\n\n## Why\nCore download and verification logic.\n\n## Pattern\nURL: https://github.com/nikolasavic/lokt/releases/download/{tag}/lokt_{version}_{os}_{arch}.tar.gz\n\n## Acceptance\n- [ ] Downloads correct tarball for OS/arch\n- [ ] Verifies checksum against checksums.txt\n- [ ] Exits non-zero on checksum mismatch\n- [ ] Supports LOKT_VERSION for pinned installs","notes":"env: local\nverify: agent\nmaps-to-ac: Basic install, Version pin, Checksum verify","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T21:01:15.54215-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T21:30:19.313249-05:00","closed_at":"2026-01-27T21:30:19.313249-05:00","close_reason":"Download and checksum verification implemented in scripts/install.sh: fetches from GitHub Releases, downloads checksums.txt, verifies SHA256, supports LOKT_VERSION for pinned installs.","labels":["L-188","task"],"dependencies":[{"issue_id":"lokt-v03.2","depends_on_id":"lokt-v03","type":"parent-child","created_at":"2026-01-27T21:01:15.549866-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-v03.2","depends_on_id":"lokt-v03.1","type":"blocks","created_at":"2026-01-27T21:01:27.333135-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-v03.3","title":"L-188 script: add install location logic","description":"## What\nAdd install location selection:\n1. LOKT_INSTALL_DIR if set\n2. ~/.local/bin if writable (and suggest adding to PATH)\n3. /usr/local/bin with sudo prompt\n\n## Why\nFlexible install locations for different user setups.\n\n## Pattern\nCheck writability with test -w, prompt for sudo only when needed.\n\n## Acceptance\n- [ ] Respects LOKT_INSTALL_DIR\n- [ ] Defaults to ~/.local/bin if writable\n- [ ] Falls back to /usr/local/bin with sudo\n- [ ] Prints PATH hint if needed\n- [ ] Idempotent: overwrites existing binary","notes":"env: local\nverify: agent\nmaps-to-ac: Basic install, Idempotent","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T21:01:18.009737-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T21:30:22.03693-05:00","closed_at":"2026-01-27T21:30:22.03693-05:00","close_reason":"Install location logic implemented: LOKT_INSTALL_DIR \u003e ~/.local/bin \u003e /usr/local/bin with sudo. Checks writability, prompts for sudo only when needed, handles idempotent updates.","labels":["L-188","task"],"dependencies":[{"issue_id":"lokt-v03.3","depends_on_id":"lokt-v03","type":"parent-child","created_at":"2026-01-27T21:01:18.01759-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-v03.3","depends_on_id":"lokt-v03.2","type":"blocks","created_at":"2026-01-27T21:01:27.489879-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-v03.4","title":"L-188 docs: add install instructions to README","description":"## What\nUpdate README.txt with install instructions:\n- curl | sh one-liner\n- Environment variables (LOKT_VERSION, LOKT_INSTALL_DIR)\n- Manual download alternative\n\n## Why\nUsers need to know how to install.\n\n## Pattern\nKeep README.txt format (ASCII art header, plain text).\n\n## Acceptance\n- [ ] README.txt has INSTALL section\n- [ ] Shows curl | sh command\n- [ ] Documents env vars","notes":"env: local\nverify: agent\nmaps-to-ac: Basic install","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T21:01:20.698076-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T21:30:43.990749-05:00","closed_at":"2026-01-27T21:30:43.990749-05:00","close_reason":"Added INSTALL section to README.txt with curl|sh one-liner, environment variables documentation, and supported platforms.","labels":["L-188","task"],"dependencies":[{"issue_id":"lokt-v03.4","depends_on_id":"lokt-v03","type":"parent-child","created_at":"2026-01-27T21:01:20.707612-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-v03.4","depends_on_id":"lokt-v03.3","type":"blocks","created_at":"2026-01-27T21:01:27.652024-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-v2n","title":"lokt-al5 verify:sandbox free lock","description":"## Check\nlokt why reports lock is free when no lock exists.\n\n## Command\nlokt why nonexistent-lock-name\n\n## Expected\n- Output contains \"free\" or \"acquisition would succeed\"\n- Exit code 0","notes":"env: sandbox\nverify: agent\nmaps-to-ac: happy-path-no-lock","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:12:38.639661-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:22:44.320538-05:00","closed_at":"2026-01-28T22:22:44.320538-05:00","close_reason":"Verified: lokt why nonexistent → FREE, exit 0","dependencies":[{"issue_id":"lokt-v2n","depends_on_id":"lokt-pne","type":"blocks","created_at":"2026-01-28T22:12:53.654404-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-vsb","title":"L-200 guard: add heartbeat goroutine","description":"## What\nModify `cmdGuard()` in `cmd/lokt/main.go` to start a heartbeat goroutine when `--ttl` is specified.\n\n## Why\nThe heartbeat goroutine is the core feature - it renews the lock at TTL/2 intervals while the child runs.\n\n## Pattern\nMirror: `cmd/lokt/main.go:cmdGuard` — existing signal handling and deferred cleanup\n\n## Implementation\n1. After acquiring lock, if TTL \u003e 0:\n   - Create cancellable context: `heartbeatCtx, cancelHeartbeat := context.WithCancel(context.Background())`\n   - Defer `cancelHeartbeat()`\n   - Start `go renewHeartbeat(heartbeatCtx, rootDir, name, *ttl, auditor)`\n2. Implement `renewHeartbeat()` function:\n   - Calculate interval = TTL/2 (min 500ms)\n   - Create ticker\n   - Loop: select on ctx.Done() or ticker.C\n   - On tick: call `lock.Renew()`, log warning on error\n3. Ensure cancelHeartbeat() is called on all exit paths (defer handles this)\n\n## Acceptance\n- [ ] Heartbeat starts when `--ttl` is specified\n- [ ] Heartbeat does NOT start when `--ttl` is not specified\n- [ ] Interval is TTL/2, minimum 500ms\n- [ ] Heartbeat stops when child exits\n- [ ] Heartbeat stops on SIGINT/SIGTERM\n- [ ] Renewal failure logs warning but doesn't kill child","notes":"env: local\nverify: agent\nmaps-to-ac: heartbeat-interval, child-completion-stops-heartbeat, no-renewal-without-ttl","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:00:26.232398-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:04:23.514966-05:00","closed_at":"2026-01-28T09:04:23.514966-05:00","close_reason":"Added runHeartbeat goroutine to cmdGuard. Starts at TTL/2 intervals (min 500ms), logs warnings on failure, stops on context cancellation.","dependencies":[{"issue_id":"lokt-vsb","depends_on_id":"lokt-x7r","type":"blocks","created_at":"2026-01-28T09:00:39.250805-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-vsb","depends_on_id":"lokt-ki7","type":"blocks","created_at":"2026-01-28T09:00:39.42977-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-x7r","title":"L-200 lock: add Renew function","description":"## What\nAdd `Renew(rootDir, name string, opts RenewOptions) error` function to `internal/lock/renew.go`.\n\n## Why\nCore renewal logic needs to be encapsulated in the lock package where other lock operations live. This function reads the existing lock, verifies ownership, updates the timestamp, and rewrites atomically.\n\n## Pattern\nMirror: `internal/lock/acquire.go` — identity verification, atomic writes\n\n## Implementation\n1. Create `internal/lock/renew.go`\n2. `RenewOptions` struct with Auditor field\n3. Read existing lock via `lockfile.Read()`\n4. Verify owner/host/pid matches current identity\n5. Update `AcquiredAt` to `time.Now()`\n6. Write back via `lockfile.Write()` (atomic)\n7. Emit audit event on success\n\n## Acceptance\n- [ ] `Renew()` function exists and compiles\n- [ ] Returns error if lock file doesn't exist\n- [ ] Returns error if owner/host/pid mismatch (\"lock stolen\")\n- [ ] Updates `acquired_ts` to current time on success\n- [ ] Uses atomic write pattern (temp + rename + fsync)","notes":"env: local\nverify: agent\nmaps-to-ac: renewal-updates-timestamp, renewal-is-atomic, stolen-lock-detection","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:00:21.461757-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:03:20.299653-05:00","closed_at":"2026-01-28T09:03:20.299653-05:00","close_reason":"Created internal/lock/renew.go with Renew function, owner verification, and audit event emission"}
{"id":"lokt-xng","title":"L-200 verify:sandbox no heartbeat without TTL","description":"## Check\nVerify that guard without TTL does not create heartbeat overhead.\n\n## Command\n```bash\n# Run guard without TTL\n./lokt guard test-no-ttl -- sleep 2\n\n# Check audit log - should have acquire/release but NO renew\n./lokt audit --since 1m --name test-no-ttl\n```\n\n## Expected\n- Audit log should show 'acquire' and 'release' events\n- Audit log should NOT show any 'renew' events","notes":"env: sandbox\nverify: agent\nmaps-to-ac: no-renewal-without-ttl","status":"closed","priority":3,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:01:12.475292-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T15:52:47.365476-05:00","closed_at":"2026-01-28T15:52:47.365476-05:00","close_reason":"Verified: guard without TTL emitted 0 renew events. Only acquire and release in audit log."}
{"id":"lokt-xy7","title":"lokt-al5 verify:sandbox","description":"Verification for lokt-al5 why command.\n\nLinked story epic: lokt-qxd\n\n## Scope\nAll checks are agent-verifiable via CLI commands in a sandbox environment.\n\n## Environments\nsandbox (local lokt root with test lock files)","notes":"linked-story: lokt-qxd\nverify-level: required","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T22:12:30.147988-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T22:22:53.182594-05:00","closed_at":"2026-01-28T22:22:53.182594-05:00","close_reason":"All 4 agent verification tasks passed."}
{"id":"lokt-y24","title":"L-130 verify:local","description":"Verification for L-130 TTL \u0026 Stale Lock Handling\n\nLinked story: lokt-b0a\n\n## Scope\n- Agent-verifiable: Unit tests, CLI tests\n\n## Environments\nlocal","notes":"linked-story: lokt-b0a\nverify-level: agent","status":"closed","priority":3,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:22:57.436712-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:24:30.135906-05:00","closed_at":"2026-01-27T09:24:30.135906-05:00","close_reason":"All verification tasks passed","labels":["L-130","verification"]}
{"id":"lokt-y24.1","title":"L-130 verify:local unit tests pass","description":"## Check\nAll unit tests pass including new stale detection tests.\n\n## Command\n```bash\ngo test ./...\n```\n\n## Expected\nAll tests pass, including:\n- internal/stale tests\n- internal/lock/release_test.go with break-stale cases","notes":"env: local\nverify: agent\nmaps-to-ac: all","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:23:11.511272-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:06:41.669493-05:00","closed_at":"2026-01-27T09:06:41.669493-05:00","close_reason":"## Evidence\n- All unit tests pass\n- internal/stale: 7 tests (PID liveness, TTL expiry, cross-host)\n- internal/lock: 12 tests (acquire race, release, break-stale)\n- internal/lockfile: 4 tests (expiry, read/write)\n- Total: 23 tests passing","labels":["L-130","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-y24.1","depends_on_id":"lokt-y24","type":"parent-child","created_at":"2026-01-27T08:23:11.513044-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-y24.2","title":"L-130 verify:local --break-stale works","description":"## Check\n`unlock --break-stale` correctly removes expired locks and rejects non-stale locks.\n\n## Steps\n```bash\n# Create expired lock\nlokt lock --ttl 1s test-stale\nsleep 2\n\n# Should succeed (lock is expired)\nlokt unlock --break-stale test-stale\necho \"Exit code: $?\"\n\n# Create non-expired lock\nlokt lock --ttl 5m test-active\n\n# Should fail (lock not stale)\nlokt unlock --break-stale test-active\necho \"Exit code: $?\"\n\n# Cleanup\nlokt unlock --force test-active\n```\n\n## Expected\n- First unlock succeeds (exit 0)\n- Second unlock fails with \"not stale\" message (exit 1)","notes":"env: local\nverify: agent\nmaps-to-ac: R1","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:23:14.326902-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:15:20.460718-05:00","closed_at":"2026-01-27T09:15:20.460718-05:00","close_reason":"## Evidence\n- Expired TTL lock: --break-stale succeeds (exit 0)\n- Dead PID on same host: --break-stale succeeds (exit 0) - correct behavior\n- Cross-host lock without TTL: --break-stale fails (exit 1) with message 'cannot verify PID on remote host'\n- Error messages are clear and descriptive\n- All scenarios work as designed","labels":["L-130","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-y24.2","depends_on_id":"lokt-y24","type":"parent-child","created_at":"2026-01-27T08:23:14.329341-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-y24.3","title":"L-130 verify:local status shows liveness","description":"## Check\n`lokt status` displays PID liveness information.\n\n## Steps\n```bash\n# Create a lock\nlokt lock test-liveness\n\n# Check status shows alive (our PID)\nlokt status test-liveness\n\n# Cleanup\nlokt unlock test-liveness\n```\n\n## Expected\n- Status output includes `pid: \u003cnumber\u003e (alive)` or similar\n- Brief listing shows liveness indicator","notes":"env: local\nverify: agent\nmaps-to-ac: R2","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T08:23:16.807211-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T09:16:18.975464-05:00","closed_at":"2026-01-27T09:16:18.975464-05:00","close_reason":"## Evidence\n- Detailed status shows: pid: 6219 (dead) for same-host locks\n- Detailed status shows: pid: 12345 (unknown) for cross-host locks\n- Brief status shows [DEAD] marker for dead PIDs\n- Brief status shows no marker for unknown (cannot verify)\n- All liveness states displayed correctly","labels":["L-130","verification","verify-agent"],"dependencies":[{"issue_id":"lokt-y24.3","depends_on_id":"lokt-y24","type":"parent-child","created_at":"2026-01-27T08:23:16.808984-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-z8x","title":"L-126: Add --json flag to status command","description":"Machine-readable JSON output for lokt status. Enables scripting, CI/CD integration, and monitoring tools to parse lock state reliably.","status":"closed","priority":2,"issue_type":"epic","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T13:49:28.20629-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:53:24.005757-05:00","closed_at":"2026-01-27T13:53:24.005757-05:00","close_reason":"L-126 complete: status --json outputs machine-readable JSON"}
{"id":"lokt-z8x.1","title":"Add StatusOutput struct with computed fields","description":"Create output struct embedding Lock plus age_sec, expired, pid_status computed fields for JSON marshaling","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T13:49:47.104204-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:53:09.372591-05:00","closed_at":"2026-01-27T13:53:09.372591-05:00","close_reason":"Implemented StatusOutput struct and --json flag","dependencies":[{"issue_id":"lokt-z8x.1","depends_on_id":"lokt-z8x","type":"parent-child","created_at":"2026-01-27T13:49:47.106973-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-z8x.2","title":"Implement --json flag for status command","description":"Add --json bool flag. For single lock: output JSON object. For list: output JSON array. Handle empty list ([]). Works with --prune-expired.","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T13:49:50.307974-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:53:09.406412-05:00","closed_at":"2026-01-27T13:53:09.406412-05:00","close_reason":"Implemented StatusOutput struct and --json flag","dependencies":[{"issue_id":"lokt-z8x.2","depends_on_id":"lokt-z8x","type":"parent-child","created_at":"2026-01-27T13:49:50.309841-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-z8x.2","depends_on_id":"lokt-z8x.1","type":"blocks","created_at":"2026-01-27T13:50:00.934804-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-z8x.3","title":"Add tests for status --json","description":"Test JSON output for: single lock, list, empty list, not found error, combined with --prune-expired","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-27T13:49:54.086878-05:00","created_by":"Nikola Savic","updated_at":"2026-01-27T13:53:17.120659-05:00","closed_at":"2026-01-27T13:53:17.120659-05:00","close_reason":"Manual testing: empty list [], single lock JSON, list JSON, not found error code 3","dependencies":[{"issue_id":"lokt-z8x.3","depends_on_id":"lokt-z8x","type":"parent-child","created_at":"2026-01-27T13:49:54.088838-05:00","created_by":"Nikola Savic"},{"issue_id":"lokt-z8x.3","depends_on_id":"lokt-z8x.2","type":"blocks","created_at":"2026-01-27T13:50:01.087744-05:00","created_by":"Nikola Savic"}]}
{"id":"lokt-zcd","title":"L-200 test: add renewal tests","description":"## What\nAdd unit tests for the renewal functionality.\n\n## Why\nEnsure the renewal logic works correctly and edge cases are handled.\n\n## Pattern\nMirror: `internal/lock/acquire_test.go` and `internal/lock/release_test.go`\n\n## Tests to Add\n1. `TestRenew_Success` - renew updates timestamp\n2. `TestRenew_NotFound` - error when lock file doesn't exist\n3. `TestRenew_NotOwner` - error when owner mismatch\n4. `TestRenew_DifferentHost` - error when host mismatch\n5. `TestRenew_DifferentPID` - error when PID mismatch\n6. `TestRenew_AuditEvent` - renew event emitted on success\n\n## Acceptance\n- [ ] All tests pass\n- [ ] Tests cover success and error paths\n- [ ] Tests verify audit event emission","notes":"env: local\nverify: agent\nmaps-to-ac: renewal-is-atomic, stolen-lock-detection, audit-events-for-renewal","status":"closed","priority":2,"issue_type":"task","owner":"nikolasavic@gmail.com","created_at":"2026-01-28T09:00:28.800421-05:00","created_by":"Nikola Savic","updated_at":"2026-01-28T09:05:29.996595-05:00","closed_at":"2026-01-28T09:05:29.996595-05:00","close_reason":"Added 7 tests in internal/lock/renew_test.go covering success, not found, owner mismatch, host mismatch, PID mismatch, audit event, and nil auditor cases.","dependencies":[{"issue_id":"lokt-zcd","depends_on_id":"lokt-x7r","type":"blocks","created_at":"2026-01-28T09:00:39.613643-05:00","created_by":"Nikola Savic"}]}
